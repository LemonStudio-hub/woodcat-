<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB数据管理器测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>IndexedDB数据管理器测试</h1>
    
    <div class="test-section">
        <h2>功能测试</h2>
        <button id="testSave">保存数据</button>
        <button id="testLoad">读取数据</button>
        <button id="testDelete">删除数据</button>
        <button id="testGetAll">获取所有数据</button>
        <button id="testClearGame">清空游戏数据</button>
        <button id="testStorageInfo">存储信息</button>
    </div>
    
    <div class="test-section">
        <h2>性能测试</h2>
        <button id="perfTest">性能测试（1000次操作）</button>
        <label>操作次数: <input type="number" id="opCount" value="1000" min="1" max="10000"></label>
    </div>
    
    <div class="test-section">
        <h2>操作日志</h2>
        <div id="log" class="log"></div>
    </div>

    <script src="js/data-manager.js"></script>
    <script>
        function log(message, isError = false) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            if (isError) {
                logDiv.className = 'log error';
            }
            console.log(message);
        }
        
        async function testSave() {
            log('开始测试保存数据...');
            try {
                const testData = {
                    score: Math.floor(Math.random() * 1000),
                    level: Math.floor(Math.random() * 10),
                    timestamp: Date.now()
                };
                
                const success = await gameDataManager.saveData('tetris', 'highScore', testData);
                
                if (success) {
                    log('✅ 数据保存成功');
                } else {
                    log('❌ 数据保存失败', true);
                }
            } catch (error) {
                log(`❌ 保存数据时出错: ${error.message}`, true);
            }
        }
        
        async function testLoad() {
            log('开始测试读取数据...');
            try {
                const data = await gameDataManager.loadData('tetris', 'highScore', { score: 0 });
                log(`✅ 读取数据成功: ${JSON.stringify(data)}`);
            } catch (error) {
                log(`❌ 读取数据时出错: ${error.message}`, true);
            }
        }
        
        async function testDelete() {
            log('开始测试删除数据...');
            try {
                const success = await gameDataManager.removeData('tetris', 'highScore');
                if (success) {
                    log('✅ 数据删除成功');
                } else {
                    log('❌ 数据删除失败', true);
                }
            } catch (error) {
                log(`❌ 删除数据时出错: ${error.message}`, true);
            }
        }
        
        async function testGetAll() {
            log('开始测试获取所有数据...');
            try {
                const allData = await gameDataManager.getAllGameData();
                log(`✅ 获取所有数据成功，共 ${Object.keys(allData).length} 条记录`);
                if (Object.keys(allData).length > 0) {
                    log(`示例数据: ${JSON.stringify(Object.entries(allData)[0])}`);
                }
            } catch (error) {
                log(`❌ 获取所有数据时出错: ${error.message}`, true);
            }
        }
        
        async function testClearGame() {
            log('开始测试清空游戏数据...');
            try {
                const count = await gameDataManager.clearGameAllData('tetris');
                log(`✅ 清空游戏数据成功，删除了 ${count} 条记录`);
            } catch (error) {
                log(`❌ 清空游戏数据时出错: ${error.message}`, true);
            }
        }
        
        async function testStorageInfo() {
            log('开始测试存储信息...');
            try {
                const info = await gameDataManager.getStorageInfo();
                log(`✅ 获取存储信息成功:\n                总记录数: ${info.count}\n                总大小: ${info.totalSize} 字节\n                游戏数据: ${JSON.stringify(info.gameSizes)}`);
            } catch (error) {
                log(`❌ 获取存储信息时出错: ${error.message}`, true);
            }
        }
        
        async function perfTest() {
            const count = parseInt(document.getElementById('opCount').value) || 1000;
            log(`开始性能测试，执行 ${count} 次操作...`);
            
            const start = performance.now();
            
            try {
                // 批量保存测试
                for (let i = 0; i < count; i++) {
                    await gameDataManager.saveData('perf_test', `data_${i}`, {
                        id: i,
                        value: `test_value_${i}`,
                        timestamp: Date.now()
                    });
                    
                    if (i % 100 === 0) {
                        log(`已保存 ${i} 条数据...`);
                    }
                }
                
                const mid = performance.now();
                
                // 批量读取测试
                for (let i = 0; i < Math.min(100, count); i++) {  // 只读取前100个以节省时间
                    const data = await gameDataManager.loadData('perf_test', `data_${i}`, null);
                    if (data && i % 50 === 0) {
                        log(`读取数据 ${i}: ${JSON.stringify(data)}`);
                    }
                }
                
                const end = performance.now();
                
                log(`✅ 性能测试完成!\n                保存 ${count} 条数据耗时: ${(mid - start).toFixed(2)}ms\n                读取 ${Math.min(100, count)} 条数据耗时: ${(end - mid).toFixed(2)}ms\n                总耗时: ${(end - start).toFixed(2)}ms`);
            } catch (error) {
                log(`❌ 性能测试出错: ${error.message}`, true);
            }
        }
        
        // 绑定事件
        document.getElementById('testSave').addEventListener('click', testSave);
        document.getElementById('testLoad').addEventListener('click', testLoad);
        document.getElementById('testDelete').addEventListener('click', testDelete);
        document.getElementById('testGetAll').addEventListener('click', testGetAll);
        document.getElementById('testClearGame').addEventListener('click', testClearGame);
        document.getElementById('testStorageInfo').addEventListener('click', testStorageInfo);
        document.getElementById('perfTest').addEventListener('click', perfTest);
        
        log('IndexedDB数据管理器测试页面已加载。请等待数据库初始化完成...');
    </script>
</body>
</html>