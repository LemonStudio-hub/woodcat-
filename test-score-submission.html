<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•°æäº¤åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
        input, select {
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>åˆ†æ•°æäº¤åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æ¨¡æ‹Ÿåˆ†æ•°æäº¤</h2>
        <label>æ¸¸æˆ: <select id="gameSelect">
            <option value="tetris">ä¿„ç½—æ–¯æ–¹å—</option>
            <option value="snake">è´ªåƒè›‡</option>
            <option value="minesweeper">æ‰«é›·</option>
            <option value="2048">2048</option>
            <option value="chess">å›½é™…è±¡æ£‹</option>
            <option value="checkers">è·³æ£‹</option>
            <option value="tic-tac-toe">äº•å­—æ£‹</option>
            <option value="memory-card">è®°å¿†å¡ç‰Œ</option>
            <option value="arkanoid">æ‰“ç –å—</option>
        </select></label>
        <label>åˆ†æ•°: <input type="number" id="scoreInput" value="1234"></label>
        <label>æ˜µç§°: <input type="text" id="playerNameInput" value="æµ‹è¯•ç©å®¶"></label>
        <br><br>
        <button id="testSubmit">æµ‹è¯•æäº¤åˆ†æ•°</button>
        <button id="testLoad">æµ‹è¯•åŠ è½½æ’è¡Œæ¦œ</button>
        <button id="testLocalData">æŸ¥çœ‹æœ¬åœ°æ•°æ®</button>
    </div>
    
    <div class="test-section">
        <h2>æ“ä½œæ—¥å¿—</h2>
        <div id="log" class="log"></div>
    </div>

    <script src="js/data-manager.js"></script>
    <script>
        function log(message, isError = false) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            if (isError) {
                logDiv.className = 'log error';
            }
            console.log(message);
        }
        
        // æ¨¡æ‹Ÿgameså¯¹è±¡
        const games = {
            tetris: { title: 'ä¿„ç½—æ–¯æ–¹å—' },
            snake: { title: 'è´ªåƒè›‡' },
            minesweeper: { title: 'æ‰«é›·' },
            '2048': { title: '2048' },
            chess: { title: 'å›½é™…è±¡æ£‹' },
            checkers: { title: 'è·³æ£‹' },
            'tic-tac-toe': { title: 'äº•å­—æ£‹' },
            'memory-card': { title: 'è®°å¿†å¡ç‰Œ' },
            'arkanoid': { title: 'æ‰“ç –å—' }
        };
        
        async function testSubmit() {
            log('å¼€å§‹æµ‹è¯•åˆ†æ•°æäº¤...');
            
            const game = document.getElementById('gameSelect').value;
            const score = parseInt(document.getElementById('scoreInput').value);
            const playerName = document.getElementById('playerNameInput').value.trim();
            
            if (!playerName) {
                log('è¯·è¾“å…¥æ˜µç§°', true);
                return;
            }
            
            try {
                // æ¨¡æ‹Ÿæäº¤åˆ†æ•°çš„é€»è¾‘
                const insertData = {
                    player_name: playerName,
                    score: score,
                    game: games[game]?.title || game,
                    created_at: new Date().toISOString()
                };
                
                log(`å‡†å¤‡æäº¤æ•°æ®: ${JSON.stringify(insertData)}`);
                
                // é¦–å…ˆä¿å­˜åˆ°æœ¬åœ°
                const localKey = `${game}_${Date.now()}`;
                const localSuccess = await gameDataManager.saveData('leaderboard', localKey, insertData);
                
                if (localSuccess) {
                    log('âœ… åˆ†æ•°å·²æˆåŠŸä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                } else {
                    log('âŒ æœ¬åœ°å­˜å‚¨å¤±è´¥', true);
                }
                
                // å°è¯•æ˜¾ç¤ºæ’è¡Œæ¦œæ•°æ®
                const localData = await gameDataManager.getAllGameData();
                const localLeaderboardEntries = Object.keys(localData)
                    .filter(key => key.startsWith('woodcat_leaderboard_'))
                    .map(key => localData[key])
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);
                
                log(`ğŸ“Š æœ¬åœ°æ’è¡Œæ¦œæ•°æ® (${localLeaderboardEntries.length} æ¡):`);
                localLeaderboardEntries.forEach((entry, index) => {
                    log(`  ${index + 1}. ${entry.player_name} - ${entry.score} - ${entry.game}`);
                });
                
            } catch (error) {
                log(`âŒ æäº¤åˆ†æ•°æ—¶å‡ºé”™: ${error.message}`, true);
            }
        }
        
        async function testLoad() {
            log('å¼€å§‹æµ‹è¯•åŠ è½½æ’è¡Œæ¦œ...');
            
            try {
                const localData = await gameDataManager.getAllGameData();
                const localLeaderboardEntries = Object.keys(localData)
                    .filter(key => key.startsWith('woodcat_leaderboard_'))
                    .map(key => localData[key])
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 20);
                
                log(`âœ… åŠ è½½åˆ° ${localLeaderboardEntries.length} æ¡æ’è¡Œæ¦œæ•°æ®:`);
                
                if (localLeaderboardEntries.length > 0) {
                    localLeaderboardEntries.forEach((entry, index) => {
                        const date = new Date(entry.created_at);
                        log(`  ${index + 1}. ${entry.player_name} - ${entry.score} - ${entry.game} - ${date.toLocaleDateString()}`);
                    });
                } else {
                    log('  æš‚æ— æ’è¡Œæ¦œæ•°æ®');
                }
            } catch (error) {
                log(`âŒ åŠ è½½æ’è¡Œæ¦œæ—¶å‡ºé”™: ${error.message}`, true);
            }
        }
        
        async function testLocalData() {
            log('å¼€å§‹æµ‹è¯•æœ¬åœ°æ•°æ®...');
            
            try {
                const storageInfo = await gameDataManager.getStorageInfo();
                log(`ğŸ“Š å­˜å‚¨ä¿¡æ¯:\n                æ€»è®°å½•æ•°: ${storageInfo.count}\n                æ€»å¤§å°: ${storageInfo.totalSize} å­—èŠ‚\n                æ¸¸æˆæ•°æ®åˆ†å¸ƒ: ${JSON.stringify(storageInfo.gameSizes)}`);
                
                const allData = await gameDataManager.getAllGameData();
                const leaderboardEntries = Object.keys(allData)
                    .filter(key => key.startsWith('woodcat_leaderboard_'))
                    .map(key => ({ key, data: allData[key] }));
                
                log(`ğŸ“‹ æœ¬åœ°æ’è¡Œæ¦œæ•°æ® (${leaderboardEntries.length} æ¡):`);
                leaderboardEntries.forEach((entry, index) => {
                    log(`  ${index + 1}. Key: ${entry.key}, Data: ${JSON.stringify(entry.data)}`);
                });
            } catch (error) {
                log(`âŒ æµ‹è¯•æœ¬åœ°æ•°æ®æ—¶å‡ºé”™: ${error.message}`, true);
            }
        }
        
        // ç»‘å®šäº‹ä»¶
        document.getElementById('testSubmit').addEventListener('click', testSubmit);
        document.getElementById('testLoad').addEventListener('click', testLoad);
        document.getElementById('testLocalData').addEventListener('click', testLocalData);
        
        log('åˆ†æ•°æäº¤åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½ã€‚');
    </script>
</body>
</html>