<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前后端交互测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
        input, select, textarea {
            padding: 5px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>前后端交互测试</h1>
    
    <div class="test-section">
        <h2>1. Supabase连接测试</h2>
        <button id="testConnection">测试Supabase连接</button>
        <button id="testSupabaseInsert">测试Supabase数据插入</button>
        <button id="testSupabaseSelect">测试Supabase数据查询</button>
        <button id="testSupabaseAll">运行Supabase完整测试</button>
    </div>
    
    <div class="test-section">
        <h2>2. 本地存储测试</h2>
        <button id="testLocalInsert">测试本地数据插入</button>
        <button id="testLocalSelect">测试本地数据查询</button>
        <button id="testLocalAll">运行本地存储完整测试</button>
    </div>
    
    <div class="test-section">
        <h2>3. 综合功能测试</h2>
        <div>
            <label>玩家名: <input type="text" id="playerName" value="测试玩家"></label>
            <label>分数: <input type="number" id="score" value="1000"></label>
            <label>游戏: <select id="game">
                <option value="tetris">俄罗斯方块</option>
                <option value="snake">贪吃蛇</option>
                <option value="minesweeper">扫雷</option>
            </select></label>
        </div>
        <button id="testSubmitScore">测试提交分数</button>
        <button id="testLoadLeaderboard">测试加载排行榜</button>
    </div>
    
    <div class="test-section">
        <h2>测试结果</h2>
        <div id="log" class="log"></div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        // 全局变量
        let supabaseClient = null;
        let supabaseLoaded = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            logDiv.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // 动态加载Supabase库
        async function loadSupabase() {
            if (typeof window.supabase !== 'undefined') {
                log('Supabase库已加载', 'info');
                return true;
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = () => {
                    log('Supabase库加载成功', 'success');
                    resolve(true);
                };
                script.onerror = () => {
                    log('Supabase库加载失败', 'error');
                    reject(false);
                };
                document.head.appendChild(script);
            });
        }
        
        // 初始化Supabase客户端
        async function initSupabase() {
            if (supabaseLoaded) {
                return supabaseClient;
            }
            
            try {
                await loadSupabase();
                
                if (window.AppConfig && window.AppConfig.supabase) {
                    supabaseClient = window.supabase.createClient(
                        window.AppConfig.supabase.url,
                        window.AppConfig.supabase.key
                    );
                    supabaseLoaded = true;
                    log('Supabase客户端初始化成功', 'success');
                    return supabaseClient;
                } else {
                    log('Supabase配置未找到', 'error');
                    return null;
                }
            } catch (error) {
                log(`Supabase初始化失败: ${error.message}`, 'error');
                return null;
            }
        }
        
        // 测试Supabase连接
        async function testSupabaseConnection() {
            log('开始测试Supabase连接...', 'info');
            
            const client = await initSupabase();
            if (!client) {
                log('无法初始化Supabase客户端', 'error');
                return false;
            }
            
            try {
                const { data, error } = await client
                    .from('leaderboard')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    log(`连接测试失败: ${error.message}`, 'error');
                    log(`错误代码: ${error.code}`, 'error');
                    log(`错误详情: ${error.details || 'N/A'}`, 'error');
                    return false;
                }
                
                log('Supabase连接测试成功！', 'success');
                log(`可访问leaderboard表，返回 ${data ? data.length : 0} 条记录`, 'info');
                return true;
            } catch (error) {
                log(`连接测试异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 测试Supabase数据插入
        async function testSupabaseInsert() {
            log('开始测试Supabase数据插入...', 'info');
            
            const client = await initSupabase();
            if (!client) {
                log('无法初始化Supabase客户端', 'error');
                return false;
            }
            
            const testData = {
                player_name: `测试_${Date.now()}`,
                score: Math.floor(Math.random() * 10000),
                game: '测试游戏',
                created_at: new Date().toISOString()
            };
            
            log(`插入测试数据: ${JSON.stringify(testData)}`, 'info');
            
            try {
                const { data, error } = await client
                    .from('leaderboard')
                    .insert([testData]);
                
                if (error) {
                    log(`插入失败: ${error.message}`, 'error');
                    log(`错误代码: ${error.code}`, 'error');
                    log(`错误详情: ${error.details || 'N/A'}`, 'error');
                    return false;
                }
                
                log('数据插入成功！', 'success');
                log(`插入数据ID: ${data ? data.length : 'N/A'}`, 'info');
                return true;
            } catch (error) {
                log(`插入异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 测试Supabase数据查询
        async function testSupabaseSelect() {
            log('开始测试Supabase数据查询...', 'info');
            
            const client = await initSupabase();
            if (!client) {
                log('无法初始化Supabase客户端', 'error');
                return false;
            }
            
            try {
                const { data, error } = await client
                    .from('leaderboard')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    log(`查询失败: ${error.message}`, 'error');
                    log(`错误代码: ${error.code}`, 'error');
                    log(`错误详情: ${error.details || 'N/A'}`, 'error');
                    return false;
                }
                
                log('数据查询成功！', 'success');
                log(`查询到 ${data ? data.length : 0} 条记录:`, 'info');
                if (data && data.length > 0) {
                    data.forEach((item, index) => {
                        log(`  ${index + 1}. ${item.player_name} - ${item.score} - ${item.game}`, 'info');
                    });
                }
                return true;
            } catch (error) {
                log(`查询异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 运行Supabase完整测试
        async function testSupabaseAll() {
            log('开始运行Supabase完整测试...', 'info');
            
            const tests = [
                { name: '连接测试', fn: testSupabaseConnection },
                { name: '插入测试', fn: testSupabaseInsert },
                { name: '查询测试', fn: testSupabaseSelect }
            ];
            
            let passed = 0;
            for (const test of tests) {
                log(`\n执行${test.name}...`, 'info');
                const result = await test.fn();
                if (result) {
                    log(`${test.name}通过`, 'success');
                    passed++;
                } else {
                    log(`${test.name}失败`, 'error');
                }
            }
            
            log(`\nSupabase完整测试完成: ${passed}/${tests.length} 项通过`, 'info');
            return passed === tests.length;
        }
        
        // 测试本地数据插入
        async function testLocalInsert() {
            log('开始测试本地数据插入...', 'info');
            
            try {
                const testData = {
                    player_name: `本地测试_${Date.now()}`,
                    score: Math.floor(Math.random() * 10000),
                    game: '本地测试游戏',
                    created_at: new Date().toISOString()
                };
                
                log(`插入本地测试数据: ${JSON.stringify(testData)}`, 'info');
                
                const success = await gameDataManager.saveData(
                    'leaderboard', 
                    `test_${Date.now()}`, 
                    testData
                );
                
                if (success) {
                    log('本地数据插入成功！', 'success');
                    return true;
                } else {
                    log('本地数据插入失败', 'error');
                    return false;
                }
            } catch (error) {
                log(`本地插入异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 测试本地数据查询
        async function testLocalSelect() {
            log('开始测试本地数据查询...', 'info');
            
            try {
                const allData = await gameDataManager.getAllGameData();
                const leaderboardEntries = Object.keys(allData)
                    .filter(key => key.startsWith('woodcat_leaderboard_'))
                    .map(key => ({ key, data: allData[key] }));
                
                log(`本地查询成功！`, 'success');
                log(`找到 ${leaderboardEntries.length} 条本地排行榜数据:`, 'info');
                
                if (leaderboardEntries.length > 0) {
                    leaderboardEntries.slice(0, 5).forEach((entry, index) => {
                        log(`  ${index + 1}. Key: ${entry.key}, Data: ${JSON.stringify(entry.data)}`, 'info');
                    });
                }
                
                return true;
            } catch (error) {
                log(`本地查询异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 运行本地存储完整测试
        async function testLocalAll() {
            log('开始运行本地存储完整测试...', 'info');
            
            const tests = [
                { name: '本地插入测试', fn: testLocalInsert },
                { name: '本地查询测试', fn: testLocalSelect }
            ];
            
            let passed = 0;
            for (const test of tests) {
                log(`\n执行${test.name}...`, 'info');
                const result = await test.fn();
                if (result) {
                    log(`${test.name}通过`, 'success');
                    passed++;
                } else {
                    log(`${test.name}失败`, 'error');
                }
            }
            
            log(`\n本地存储完整测试完成: ${passed}/${tests.length} 项通过`, 'info');
            return passed === tests.length;
        }
        
        // 测试提交分数
        async function testSubmitScore() {
            log('开始测试提交分数...', 'info');
            
            const playerName = document.getElementById('playerName').value || '测试玩家';
            const score = parseInt(document.getElementById('score').value) || 1000;
            const game = document.getElementById('game').value;
            
            // 首先保存到本地
            const localData = {
                player_name: playerName,
                score: score,
                game: game,
                created_at: new Date().toISOString()
            };
            
            log(`准备数据: ${JSON.stringify(localData)}`, 'info');
            
            const localSuccess = await gameDataManager.saveData(
                'leaderboard', 
                `${game}_${Date.now()}`, 
                localData
            );
            
            if (localSuccess) {
                log('✅ 本地数据保存成功', 'success');
            } else {
                log('❌ 本地数据保存失败', 'error');
            }
            
            // 尝试提交到云端
            let cloudSuccess = false;
            const client = await initSupabase();
            
            if (client) {
                try {
                    const { data, error } = await client
                        .from('leaderboard')
                        .insert([localData]);
                    
                    if (error) {
                        log(`云端提交失败: ${error.message}`, 'error');
                        log(`错误代码: ${error.code}`, 'error');
                    } else {
                        log('✅ 云端提交成功', 'success');
                        cloudSuccess = true;
                    }
                } catch (err) {
                    log(`云端提交异常: ${err.message}`, 'error');
                }
            } else {
                log('⚠️ 未连接到云端，仅保存本地', 'info');
            }
            
            if (cloudSuccess) {
                log('分数提交测试完成：云端和本地都成功', 'success');
            } else if (localSuccess) {
                log('分数提交测试完成：仅本地保存成功', 'info');
            } else {
                log('分数提交测试完成：全部失败', 'error');
            }
            
            return localSuccess || cloudSuccess;
        }
        
        // 测试加载排行榜
        async function testLoadLeaderboard() {
            log('开始测试加载排行榜...', 'info');
            
            // 从云端获取数据
            let cloudData = [];
            let cloudError = null;
            const client = await initSupabase();
            
            if (client) {
                try {
                    const { data, error } = await client
                        .from('leaderboard')
                        .select('*')
                        .order('score', { ascending: false })
                        .limit(20);
                    
                    if (error) {
                        log(`云端加载失败: ${error.message}`, 'error');
                        cloudError = error;
                    } else {
                        cloudData = data || [];
                        log(`云端加载成功: ${cloudData.length} 条记录`, 'success');
                    }
                } catch (err) {
                    log(`云端加载异常: ${err.message}`, 'error');
                    cloudError = err;
                }
            } else {
                log('⚠️ 未连接到云端，跳过云端加载', 'info');
            }
            
            // 从本地获取数据
            try {
                const localData = await gameDataManager.getAllGameData();
                const localLeaderboardEntries = Object.keys(localData)
                    .filter(key => key.startsWith('woodcat_leaderboard_'))
                    .map(key => localData[key])
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 20);
                
                log(`本地加载成功: ${localLeaderboardEntries.length} 条记录`, 'success');
                
                // 合并数据并显示
                const combinedDataMap = new Map();
                
                // 添加云端数据
                cloudData.forEach(item => {
                    const key = `${item.player_name}_${item.game}_${item.score}`;
                    if (!combinedDataMap.has(key)) {
                        combinedDataMap.set(key, item);
                    }
                });
                
                // 添加本地数据
                localLeaderboardEntries.forEach(item => {
                    const key = `${item.player_name}_${item.game}_${item.score}`;
                    if (!combinedDataMap.has(key)) {
                        combinedDataMap.set(key, item);
                    }
                });
                
                const allData = Array.from(combinedDataMap.values())
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 20);
                
                log(`合并后共 ${allData.length} 条排行榜记录:`, 'info');
                
                if (allData.length > 0) {
                    log('排行榜数据:', 'info');
                    allData.forEach((entry, index) => {
                        const date = new Date(entry.created_at);
                        log(`  ${index + 1}. ${entry.player_name} - ${entry.score} - ${entry.game} - ${date.toLocaleDateString()}`, 'info');
                    });
                } else {
                    log('  暂无排行榜数据', 'info');
                }
                
                return true;
            } catch (error) {
                log(`本地加载异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        // 绑定事件
        document.getElementById('testConnection').addEventListener('click', async () => {
            await testSupabaseConnection();
        });
        
        document.getElementById('testSupabaseInsert').addEventListener('click', async () => {
            await testSupabaseInsert();
        });
        
        document.getElementById('testSupabaseSelect').addEventListener('click', async () => {
            await testSupabaseSelect();
        });
        
        document.getElementById('testSupabaseAll').addEventListener('click', async () => {
            await testSupabaseAll();
        });
        
        document.getElementById('testLocalInsert').addEventListener('click', async () => {
            await testLocalInsert();
        });
        
        document.getElementById('testLocalSelect').addEventListener('click', async () => {
            await testLocalSelect();
        });
        
        document.getElementById('testLocalAll').addEventListener('click', async () => {
            await testLocalAll();
        });
        
        document.getElementById('testSubmitScore').addEventListener('click', async () => {
            await testSubmitScore();
        });
        
        document.getElementById('testLoadLeaderboard').addEventListener('click', async () => {
            await testLoadLeaderboard();
        });
        
        // 页面加载完成提示
        window.addEventListener('load', () => {
            log('前后端交互测试页面已加载完成', 'info');
            log('请先运行Supabase连接测试，然后进行其他测试', 'info');
        });
    </script>
</body>
</html>