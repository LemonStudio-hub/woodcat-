<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç –å— - æœ¨å¤´çŒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
            color: #333;
            overflow-x: hidden;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 18px;
            max-width: 100%;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: containerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        h1 {
            color: #2c3e50;
            margin: 8px 0 12px;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 600;
            animation: fadeIn 0.6s ease-out;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .stat-box {
            background: #e8f4f8;
            color: #2c3e50;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stat-box h3 {
            margin: 0;
            font-size: 0.75rem;
            font-weight: 600;
            color: #34495e;
        }
        
        .stat-box p {
            margin: 2px 0 0;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .game-board {
            width: 100%;
            max-width: 360px;
            height: 360px;
            margin: 8px 0 12px;
            border: 2px solid #7f8c8d;
            position: relative;
            overflow: hidden;
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #ecf0f1;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .game-container {
                padding: 12px;
                width: 100%;
                max-width: 100%;
                margin: 5px 0;
            }
            
            .game-board {
                width: 100%;
                max-width: 340px;
                height: 340px;
                margin: 8px auto;
            }
            
            #gameCanvas {
                width: 100%;
                height: 100%;
            }
            
            h1 {
                font-size: 1.4rem;
                margin: 6px 0 10px;
            }
            
            .stats {
                margin-bottom: 10px;
            }
            
            .stat-box {
                min-width: 70px;
                padding: 6px 10px;
            }
            
            .stat-box h3 {
                font-size: 0.7rem;
            }
            
            .stat-box p {
                font-size: 0.9rem;
            }
            
            .controls {
                width: 100%;
            }
            
            button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .game-board {
                width: 100%;
                max-width: 300px;
                height: 300px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .stat-box {
                min-width: 65px;
                padding: 5px 8px;
            }
            
            .stat-box h3 {
                font-size: 0.65rem;
            }
            
            .stat-box p {
                font-size: 0.85rem;
            }
            
            .gesture-hint {
                display: block !important;
            }
        }
        
        .gesture-hint {
            display: none;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .buttons {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 16px;
            font-size: 0.9rem;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: #2c3e50;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .back-home {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            text-decoration: none;
        }
        
        .back-home:hover {
            background: #2c3e50;
            transform: scale(1.15) rotate(-10deg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .back-home:active {
            transform: scale(1.05);
        }
        
        .game-over, .game-win {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            font-size: 2rem;
            text-align: center;
            display: none;
        }
        
        .game-over h2, .game-win h2 {
            margin-bottom: 20px;
            font-size: 2.5rem;
            color: #e74c3c;
        }
        
        .game-win h2 {
            color: #2ecc71;
        }
        
        .game-over p, .game-win p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes containerPop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .game-container {
                padding: 15px;
                width: 100%;
                max-width: 100%;
                margin: 5px 0;
            }
            
            h1 {
                font-size: 1.5rem;
                margin: 6px 0 10px;
            }
            
            .stats {
                margin-bottom: 10px;
            }
            
            .stat-box {
                min-width: 70px;
                padding: 6px 10px;
            }
            
            .stat-box h3 {
                font-size: 0.7rem;
            }
            
            .stat-box p {
                font-size: 0.9rem;
            }
            
            .game-board {
                height: 300px;
                margin: 6px 0 10px;
            }
            
            button {
                padding: 9px 14px;
                font-size: 0.85rem;
            }
            
            .back-home {
                top: 6px;
                left: 6px;
                width: 26px;
                height: 26px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <a class="back-home" href="../index.html">â†</a>
    <div class="game-container">
        <h1>æ‰“ç –å—</h1>
        <div class="stats">
            <div class="stat-box">
                <h3>å¾—åˆ†</h3>
                <p id="score">0</p>
            </div>
            <div class="stat-box">
                <h3>ç”Ÿå‘½</h3>
                <p id="lives">3</p>
            </div>
            <div class="stat-box">
                <h3>å…³å¡</h3>
                <p id="level">1</p>
            </div>
            <div class="stat-box">
                <h3>æœ€é«˜åˆ†</h3>
                <p id="high-score">0</p>
            </div>
        </div>
        <div class="game-board">
            <canvas id="gameCanvas"></canvas>
            <div class="game-over" id="gameOver">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
                <button id="restartBtn">é‡æ–°å¼€å§‹</button>
            </div>
            <div class="game-win" id="gameWin">
                <h2>æ­å–œé€šå…³</h2>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="winScore">0</span></p>
                <button id="nextLevelBtn">ä¸‹ä¸€å…³</button>
            </div>
        </div>
        <div class="controls">
            <div class="buttons">
                <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
                <button id="pauseBtn">æš‚åœ</button>
            </div>
            <p style="margin-top: 10px; color: #7f8c8d; font-size: 0.85rem;">ä½¿ç”¨ â† â†’ é”®ã€é¼ æ ‡æˆ–æ»‘åŠ¨æ‰‹åŠ¿ç§»åŠ¨æŒ¡æ¿</p>
        </div>
        <div class="gesture-hint" style="margin-top: 10px; color: #7f8c8d; font-size: 0.8rem; text-align: center; display: none;">
            ğŸ’¡ æç¤ºï¼šå·¦å³æ»‘åŠ¨å±å¹•å¯æ§åˆ¶æŒ¡æ¿
        </div>
    </div>

    <script src="../js/gesture-controller.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/audio-vibration.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–éŸ³é¢‘æ¨¡å—
            gameAudioVibration.initAudio();
            
            // çƒæ‹å‡»çƒéŸ³æ•ˆ
            function playPaddleHitSound() {
                gameAudioVibration.playSound(300, 100, 'sine', 0.1);
                gameAudioVibration.vibrate(50);
            }
            
            // ç –å—ç¢°æ’éŸ³æ•ˆ
            function playBrickHitSound() {
                gameAudioVibration.playSound(500, 150, 'square', 0.15);
                gameAudioVibration.vibrate(70);
            }
            
            // å¢™å£ç¢°æ’éŸ³æ•ˆ
            function playWallHitSound() {
                gameAudioVibration.playSound(200, 80, 'sine', 0.08);
                gameAudioVibration.vibrate(30);
            }
            
            // æ¸¸æˆèƒœåˆ©éŸ³æ•ˆ
            function playWinSound() {
                gameAudioVibration.playWinSound();
                gameAudioVibration.vibrateSuccess();
            }
            
            // æ¸¸æˆç»“æŸéŸ³æ•ˆ
            function playLoseSound() {
                gameAudioVibration.playLoseSound();
                gameAudioVibration.vibrateFailure();
            }
            // è·å–DOMå…ƒç´ 
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('score');
            const livesDisplay = document.getElementById('lives');
            const levelDisplay = document.getElementById('level');
            const finalScoreDisplay = document.getElementById('finalScore');
            const winScoreDisplay = document.getElementById('winScore');
            const gameOverScreen = document.getElementById('gameOver');
            const gameWinScreen = document.getElementById('gameWin');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const restartBtn = document.getElementById('restartBtn');
            const nextLevelBtn = document.getElementById('nextLevelBtn');
            
            // æ¸¸æˆå˜é‡
            let score = 0;
            let lives = 3;
            let level = 1;
            let gameRunning = false;
            let gamePaused = false;
            let animationId;
            
            // åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸
            function initCanvasSize() {
                const gameBoard = document.querySelector('.game-board');
                const containerWidth = gameBoard.clientWidth;
                const containerHeight = gameBoard.clientHeight;
                
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸ºå®¹å™¨çš„å°ºå¯¸
                canvas.width = containerWidth;
                canvas.height = containerHeight;
            }
            
            // åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸
            initCanvasSize();
            
            // çƒçš„å±æ€§
            const ball = {
                x: canvas.width / 2,
                y: canvas.height - 30,
                radius: 8,
                dx: 4,
                dy: -4,
                speed: 4
            };
            
            // æŒ¡æ¿å±æ€§
            const paddle = {
                width: Math.min(80, canvas.width * 0.2), // æŒ¡æ¿å®½åº¦ä¸è¶…è¿‡ç”»å¸ƒçš„20%
                height: 10,
                x: (canvas.width - Math.min(80, canvas.width * 0.2)) / 2,
                speed: 8
            };
            
            // ç –å—å±æ€§
            const brick = {
                rowCount: 5,
                colCount: 8,
                width: 0, // åŠ¨æ€è®¡ç®—
                height: 0, // åŠ¨æ€è®¡ç®—
                padding: 5, // åœ¨å°å±å¹•ä¸Šå‡å°é—´è·
                offsetTop: 50,
                offsetLeft: 10, // åŠ¨æ€è°ƒæ•´
                visible: []
            };
            
            // åˆå§‹åŒ–ç –å—
            function initBricks() {
                // æ ¹æ®ç”»å¸ƒå°ºå¯¸åŠ¨æ€è®¡ç®—ç –å—å¤§å°
                brick.width = (canvas.width - (brick.offsetLeft * 2) - (brick.padding * (brick.colCount + 1))) / brick.colCount;
                brick.height = Math.min(20, (canvas.height * 0.25) / brick.rowCount); // é™åˆ¶ç –å—é«˜åº¦
                
                brick.visible = [];
                for (let c = 0; c < brick.colCount; c++) {
                    brick.visible[c] = [];
                    for (let r = 0; r < brick.rowCount; r++) {
                        brick.visible[c][r] = { x: 0, y: 0, status: true };
                    }
                }
            }
            
            // ç²’å­ç³»ç»Ÿ
            const particles = [];
            
            // åˆ›å»ºç²’å­
            function createParticles(x, y, color, count = 5) {
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 2 + 1;
                    const size = Math.random() * 3 + 2;
                    const life = Math.random() * 30 + 20;
                    
                    particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        radius: size,
                        color: color,
                        life: life,
                        maxLife: life
                    });
                }
            }
            
            // æ›´æ–°ç²’å­
            function updateParticles() {
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    
                    if (p.life <= 0) {
                        particles.splice(i, 1);
                    }
                }
            }
            
            // ç»˜åˆ¶ç²’å­
            function drawParticles() {
                for (const p of particles) {
                    const alpha = p.life / p.maxLife;
                    ctx.globalAlpha = alpha;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    ctx.closePath();
                }
                ctx.globalAlpha = 1; // é‡ç½®é€æ˜åº¦
            }
            
            // ç»˜åˆ¶çƒ
            function drawBall() {
                // ä¸»çƒ
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                const gradient = ctx.createRadialGradient(
                    ball.x - 3, ball.y - 3, 1,
                    ball.x, ball.y, ball.radius
                );
                gradient.addColorStop(0, "#ffffff");
                gradient.addColorStop(0.2, "#e74c3c");
                gradient.addColorStop(1, "#c0392b");
                ctx.fillStyle = gradient;
                ctx.fill();
                ctx.closePath();
                
                // æ·»åŠ é«˜å…‰æ•ˆæœ
                ctx.beginPath();
                ctx.arc(ball.x - 3, ball.y - 3, ball.radius * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.fill();
                ctx.closePath();
            }
            
            // ç»˜åˆ¶æŒ¡æ¿
            function drawPaddle() {
                ctx.beginPath();
                ctx.roundRect(paddle.x, canvas.height - paddle.height, paddle.width, paddle.height, 5);
                ctx.fillStyle = "#3498db";
                ctx.fill();
                ctx.closePath();
                
                // æ·»åŠ é«˜å…‰æ•ˆæœ
                ctx.beginPath();
                ctx.roundRect(paddle.x, canvas.height - paddle.height, paddle.width, 3, 5);
                ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
                ctx.fill();
                ctx.closePath();
            }
            
            // è·å–ç –å—é¢œè‰²çš„è¾…åŠ©å‡½æ•°
            function getBrickColor(row) {
                switch(row) {
                    case 0: return "#e74c3c"; // çº¢è‰²
                    case 1: return "#e67e22"; // æ©™è‰²
                    case 2: return "#f1c40f"; // é»„è‰²
                    case 3: return "#2ecc71"; // ç»¿è‰²
                    case 4: return "#3498db"; // è“è‰²
                    default: return "#9b59b6"; // ç´«è‰²
                }
            }
            
            // ç»˜åˆ¶ç –å—
            function drawBricks() {
                for (let c = 0; c < brick.colCount; c++) {
                    for (let r = 0; r < brick.rowCount; r++) {
                        if (brick.visible[c][r].status) {
                            const brickX = c * (brick.width + brick.padding) + brick.offsetLeft;
                            const brickY = r * (brick.height + brick.padding) + brick.offsetTop;
                            brick.visible[c][r].x = brickX;
                            brick.visible[c][r].y = brickY;
                            
                            // æ ¹æ®è¡Œæ•°è®¾ç½®ä¸åŒé¢œè‰²
                            let color;
                            switch(r) {
                                case 0: color = "#e74c3c"; break; // çº¢è‰²
                                case 1: color = "#e67e22"; break; // æ©™è‰²
                                case 2: color = "#f1c40f"; break; // é»„è‰²
                                case 3: color = "#2ecc71"; break; // ç»¿è‰²
                                case 4: color = "#3498db"; break; // è“è‰²
                                default: color = "#9b59b6"; // ç´«è‰²
                            }
                            

                            
                            ctx.beginPath();
                            ctx.roundRect(brickX, brickY, brick.width, brick.height, 3);
                            ctx.fillStyle = color;
                            ctx.fill();
                            ctx.closePath();
                            
                            // æ·»åŠ è¾¹æ¡†
                            ctx.strokeStyle = "#2c3e50";
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    }
                }
            }
            
            // ç –å—ç¢°æ’æ£€æµ‹
            function collisionDetection() {
                for (let c = 0; c < brick.colCount; c++) {
                    for (let r = 0; r < brick.rowCount; r++) {
                        const b = brick.visible[c][r];
                        if (b.status) {
                            if (ball.x > b.x && ball.x < b.x + brick.width && 
                                ball.y > b.y && ball.y < b.y + brick.height) {
                                ball.dy = -ball.dy;
                                b.status = false;
                                score += 10;
                                scoreDisplay.textContent = score;
                                
                                // æ£€æŸ¥æ˜¯å¦æ‰“ç ´é«˜åˆ†è®°å½•
                                if (score > highScore) {
                                    highScore = score;
                                    gameDataManager.saveData('arkanoid', 'highScore', highScore);
                                }
                                
                                // æ·»åŠ ç –å—ç¢°æ’éŸ³æ•ˆå’ŒæŒ¯åŠ¨
                                playBrickHitSound();
                                brickHitVibrate();
                                
                                // åˆ›å»ºç¢°æ’ç²’å­æ•ˆæœ
                                const brickColor = getBrickColor(r); // è·å–ç –å—é¢œè‰²
                                createParticles(b.x + brick.width/2, b.y + brick.height/2, brickColor, 8);
                                
                                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç –å—éƒ½è¢«æ‰“ç ´
                                let allBricksBroken = true;
                                for (let c2 = 0; c2 < brick.colCount; c2++) {
                                    for (let r2 = 0; r2 < brick.rowCount; r2++) {
                                        if (brick.visible[c2][r2].status) {
                                            allBricksBroken = false;
                                            break;
                                        }
                                    }
                                    if (!allBricksBroken) break;
                                }
                                
                                if (allBricksBroken) {
                                    // è¿›å…¥ä¸‹ä¸€å…³
                                    levelUp();
                                }
                            }
                        }
                    }
                }
            }
            
            // æŒ¡æ¿ç§»åŠ¨
            function movePaddle(e) {
                if (!gameRunning || gamePaused) return;
                
                if (e.type === 'keydown') {
                    if (e.key === 'ArrowRight' || e.key === 'Right') {
                        paddle.x = Math.min(paddle.x + paddle.speed, canvas.width - paddle.width);
                    } else if (e.key === 'ArrowLeft' || e.key === 'Left') {
                        paddle.x = Math.max(paddle.x - paddle.speed, 0);
                    }
                } else if (e.type === 'mousemove') {
                    const relativeX = e.clientX - canvas.getBoundingClientRect().left;
                    if (relativeX > paddle.width / 2 && relativeX < canvas.width - paddle.width / 2) {
                        paddle.x = relativeX - paddle.width / 2;
                    }
                }
            }
            
            // ç§»åŠ¨çƒ
            function moveBall() {
                // é¢„æµ‹æ€§ç¢°æ’æ£€æµ‹ï¼šæ£€æŸ¥çƒçš„ç§»åŠ¨è·¯å¾„ä¸Šæ˜¯å¦æœ‰ç¢°æ’
                const nextX = ball.x + ball.dx;
                const nextY = ball.y + ball.dy;
                
                // åº•éƒ¨è¾¹ç•Œç¢°æ’æ£€æµ‹ - è¿™æ˜¯æœ€ä¼˜å…ˆçš„åˆ¤å®šï¼Œå¿…é¡»æœ€å…ˆæ£€æŸ¥
                if (nextY + ball.radius > canvas.height) {
                    // çƒè§¦åº•ï¼Œä¸ç®¡å…¶ä»–æ½œåœ¨ç¢°æ’ï¼Œéƒ½åº”åˆ¤å®šä¸ºå¤±åˆ†
                    lives--;
                    livesDisplay.textContent = lives;
                    
                    if (lives <= 0) {
                        gameOver();
                    } else {
                        resetBall();
                    }
                    return; // ç«‹å³è¿”å›ï¼Œä¸å†ç»§ç»­å¤„ç†
                }
                
                // æŒ¡æ¿ç¢°æ’æ£€æµ‹
                let paddleHit = false;
                // æ£€æŸ¥çƒæ˜¯å¦ä¼šç»è¿‡æŒ¡æ¿åŒºåŸŸ
                if (ball.y <= canvas.height - paddle.height && nextY > canvas.height - paddle.height) {
                    // çƒåœ¨å‚ç›´æ–¹å‘ä¸Šç©¿è¶ŠæŒ¡æ¿åŒºåŸŸï¼Œæ£€æŸ¥æ°´å¹³ä½ç½®
                    if (nextX >= paddle.x && nextX <= paddle.x + paddle.width) {
                        // æ ¹æ®çƒå‡»ä¸­æŒ¡æ¿çš„ä½ç½®æ”¹å˜åå¼¹è§’åº¦
                        const hitPos = (nextX - (paddle.x + paddle.width / 2)) / (paddle.width / 2);
                        ball.dx = hitPos * 5; // æ ¹æ®å‡»ä¸­ä½ç½®è°ƒæ•´æ°´å¹³é€Ÿåº¦
                        ball.dy = -Math.abs(ball.dy); // ç¡®ä¿çƒå‘ä¸Šåå¼¹
                        
                        // æ·»åŠ æŒ¡æ¿ç¢°æ’éŸ³æ•ˆå’ŒæŒ¯åŠ¨
                        playPaddleHitSound();
                        paddleHitVibrate();
                        paddleHit = true;
                    }
                }
                
                // å¦‚æœå‡»ä¸­æŒ¡æ¿ï¼Œéœ€è¦ç«‹å³æ›´æ–°é€Ÿåº¦å¹¶ç»§ç»­å¤„ç†å…¶ä»–ç¢°æ’
                if (paddleHit) {
                    // ç¡®ä¿çƒåœ¨æŒ¡æ¿ä¸Šæ–¹
                    ball.y = canvas.height - paddle.height - ball.radius;
                }
                
                // å·¦å³å¢™å£ç¢°æ’æ£€æµ‹
                if (nextX + ball.radius > canvas.width || nextX - ball.radius < 0) {
                    ball.dx = -ball.dx;
                    // æ·»åŠ å¢™å£ç¢°æ’éŸ³æ•ˆ
                    playWallHitSound();
                    wallHitVibrate();
                }
                
                // ä¸Šå¢™å£ç¢°æ’æ£€æµ‹
                if (nextY - ball.radius < 0) {
                    ball.dy = -ball.dy;
                    // æ·»åŠ å¢™å£ç¢°æ’éŸ³æ•ˆ
                    playWallHitSound();
                    wallHitVibrate();
                }
                
                // æ›´æ–°çƒä½ç½®
                ball.x = nextX;
                ball.y = nextY;
                
                collisionDetection();
            }
            
            // é‡ç½®çƒçš„ä½ç½®
            function resetBall() {
                ball.x = canvas.width / 2;
                ball.y = canvas.height - 30;
                ball.dx = 4 * (Math.random() > 0.5 ? 1 : -1); // éšæœºæ–¹å‘
                ball.dy = -4;
            }
            
            // é‡ç½®æŒ¡æ¿
            function resetPaddle() {
                paddle.x = (canvas.width - paddle.width) / 2;
            }
            
            // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
            function draw() {
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
                drawBricks();
                drawBall();
                drawPaddle();
                drawParticles(); // ç»˜åˆ¶ç²’å­æ•ˆæœ
                
                // æ˜¾ç¤ºæš‚åœæç¤º
                if (gamePaused) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.font = 'bold 24px Arial';
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    ctx.fillText('æ¸¸æˆæš‚åœ', canvas.width / 2, canvas.height / 2);
                }
            }
            
            // æ¸¸æˆå¾ªç¯
            function gameLoop() {
                if (!gameRunning) return;
                if (gamePaused) {
                    draw();
                    animationId = requestAnimationFrame(gameLoop);
                    return;
                }
                
                moveBall();
                updateParticles(); // æ›´æ–°ç²’å­
                draw();
                animationId = requestAnimationFrame(gameLoop);
            }
            
            // å¼€å§‹æ¸¸æˆ
            function startGame() {
                if (gameRunning) return;
                
                // åˆå§‹åŒ–éŸ³é¢‘ï¼ˆåœ¨ç”¨æˆ·äº¤äº’åï¼‰
                initAudio();
                
                gameRunning = true;
                gamePaused = false;
                startBtn.textContent = "é‡æ–°å¼€å§‹";
                gameLoop();
            }
            
            // æš‚åœ/æ¢å¤æ¸¸æˆ
            function togglePause() {
                if (!gameRunning) return;
                
                gamePaused = !gamePaused;
                pauseBtn.textContent = gamePaused ? "ç»§ç»­" : "æš‚åœ";
                
                if (!gamePaused) {
                    gameLoop();
                }
            }
            
            // æ¸¸æˆç»“æŸ
            function gameOver() {
                gameRunning = false;
                cancelAnimationFrame(animationId);
                finalScoreDisplay.textContent = score;
                gameOverScreen.style.display = "flex";
                
                // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
                playLoseSound();
            }
            
            // å‡çº§å…³å¡
            function levelUp() {
                gameRunning = false;
                cancelAnimationFrame(animationId);
                level++;
                levelDisplay.textContent = level;
                winScoreDisplay.textContent = score;
                gameWinScreen.style.display = "flex";
                
                // æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ
                playWinSound();
            }
            
            // å¼€å§‹ä¸‹ä¸€å…³
            function nextLevel() {
                initBricks();
                resetBall();
                resetPaddle();
                gameWinScreen.style.display = "none";
                
                // å¢åŠ éš¾åº¦
                ball.speed += 0.5;
                ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
                ball.dy = -ball.speed;
                
                gameRunning = true;
                gamePaused = false;
                gameLoop();
            }
            
            // é‡æ–°å¼€å§‹æ¸¸æˆ
            function restartGame() {
                score = 0;
                lives = 3;
                level = 1;
                
                scoreDisplay.textContent = score;
                livesDisplay.textContent = lives;
                levelDisplay.textContent = level;
                
                initBricks();
                resetBall();
                resetPaddle();
                
                gameOverScreen.style.display = "none";
                gameWinScreen.style.display = "none";
                
                // é‡ç½®çƒé€Ÿåº¦
                ball.speed = 4;
                ball.dx = 4;
                ball.dy = -4;
                
                gameRunning = true;
                gamePaused = false;
                startBtn.textContent = "é‡æ–°å¼€å§‹";
                gameLoop();
            }
            
            // äº‹ä»¶ç›‘å¬å™¨
            startBtn.addEventListener('click', startGame);
            pauseBtn.addEventListener('click', togglePause);
            restartBtn.addEventListener('click', restartGame);
            nextLevelBtn.addEventListener('click', nextLevel);
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft' || 
                    e.key === 'Right' || e.key === 'Left') {
                    e.preventDefault();
                    movePaddle(e);
                }
                
                // ç©ºæ ¼é”®æš‚åœ/ç»§ç»­
                if (e.key === ' ' && gameRunning) {
                    e.preventDefault();
                    togglePause();
                }
            });
            
            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousemove', movePaddle);
            
            // åˆå§‹åŒ–éŸ³é¢‘çš„å‡½æ•°
            function ensureAudioInitialized() {
                if (!audioInitialized) {
                    initAudio();
                }
            }
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰- ç›´æ¥ç§»åŠ¨æŒ¡æ¿åˆ°è§¦æ‘¸ä½ç½®
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                ensureAudioInitialized(); // ç¡®ä¿éŸ³é¢‘å·²åˆå§‹åŒ–
                const relativeX = e.touches[0].clientX - canvas.getBoundingClientRect().left;
                if (relativeX > paddle.width / 2 && relativeX < canvas.width - paddle.width / 2) {
                    paddle.x = relativeX - paddle.width / 2;
                }
            }, { passive: false });
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            canvas.addEventListener('mousemove', (e) => {
                ensureAudioInitialized(); // ç¡®ä¿éŸ³é¢‘å·²åˆå§‹åŒ–
                const relativeX = e.clientX - canvas.getBoundingClientRect().left;
                if (relativeX > paddle.width / 2 && relativeX < canvas.width - paddle.width / 2) {
                    paddle.x = relativeX - paddle.width / 2;
                }
            });
            
            // åˆå§‹åŒ–æ‰‹åŠ¿æ§åˆ¶å™¨
            const gestureController = new GestureController(canvas, {
                onSwipeLeft: function(e, data) {
                    // å‘å·¦æ»‘åŠ¨æ—¶ï¼ŒæŒ¡æ¿å‘å·¦ç§»åŠ¨
                    paddle.x = Math.max(0, paddle.x - paddle.speed * 2);
                    gameAudioVibration.vibrateShort(); // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                },
                onSwipeRight: function(e, data) {
                    // å‘å³æ»‘åŠ¨æ—¶ï¼ŒæŒ¡æ¿å‘å³ç§»åŠ¨
                    paddle.x = Math.min(canvas.width - paddle.width, paddle.x + paddle.speed * 2);
                    gameAudioVibration.vibrateShort(); // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                },
                minSwipeDistance: 10, // å‡å°æœ€å°æ»‘åŠ¨è·ç¦»ï¼Œæé«˜çµæ•åº¦
                preventDefault: true
            });
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´ç”»å¸ƒå°ºå¯¸
            window.addEventListener('resize', () => {
                initCanvasSize();
                
                // é‡æ–°è®¾ç½®çƒå’ŒæŒ¡æ¿çš„å±æ€§ä»¥é€‚åº”æ–°å°ºå¯¸
                ball.x = canvas.width / 2;
                ball.y = canvas.height - 30;
                
                paddle.width = Math.min(80, canvas.width * 0.2);
                paddle.x = (canvas.width - paddle.width) / 2;
            });
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initBricks();
            draw();
        });
    </script>
</body>
</html>