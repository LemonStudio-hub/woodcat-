<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“ç –å— - æœ¨å¤´çŒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 15px;
            color: #333;
            overflow-x: hidden;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 18px;
            max-width: 100%;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: containerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        h1 {
            color: #2c3e50;
            margin: 8px 0 12px;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 600;
            animation: fadeIn 0.6s ease-out;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .stat-box {
            background: #e8f4f8;
            color: #2c3e50;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stat-box h3 {
            margin: 0;
            font-size: 0.75rem;
            font-weight: 600;
            color: #34495e;
        }
        
        .stat-box p {
            margin: 2px 0 0;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .game-board {
            width: 100%;
            max-width: 360px;
            height: 360px;
            margin: 8px 0 12px;
            border: 2px solid #7f8c8d;
            position: relative;
            overflow: hidden;
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #ecf0f1;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .game-container {
                padding: 12px;
                width: 100%;
                max-width: 100%;
                margin: 5px 0;
            }
            
            .game-board {
                width: 100%;
                max-width: 340px;
                height: 340px;
                margin: 8px auto;
            }
            
            #gameCanvas {
                width: 100%;
                height: 100%;
            }
            
            h1 {
                font-size: 1.4rem;
                margin: 6px 0 10px;
            }
            
            .stats {
                margin-bottom: 10px;
            }
            
            .stat-box {
                min-width: 70px;
                padding: 6px 10px;
            }
            
            .stat-box h3 {
                font-size: 0.7rem;
            }
            
            .stat-box p {
                font-size: 0.9rem;
            }
            
            .controls {
                width: 100%;
            }
            
            button {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .game-board {
                width: 100%;
                max-width: 300px;
                height: 300px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .stat-box {
                min-width: 65px;
                padding: 5px 8px;
            }
            
            .stat-box h3 {
                font-size: 0.65rem;
            }
            
            .stat-box p {
                font-size: 0.85rem;
            }
            
            .gesture-hint {
                display: block !important;
            }
        }
        
        .gesture-hint {
            display: none;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .buttons {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 16px;
            font-size: 0.9rem;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: #2c3e50;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .back-home {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            text-decoration: none;
        }
        
        .back-home:hover {
            background: #2c3e50;
            transform: scale(1.15) rotate(-10deg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .back-home:active {
            transform: scale(1.05);
        }
        
        .game-over, .game-win {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            font-size: 2rem;
            text-align: center;
            display: none;
        }
        
        .game-over h2, .game-win h2 {
            margin-bottom: 20px;
            font-size: 2.5rem;
            color: #e74c3c;
        }
        
        .game-win h2 {
            color: #2ecc71;
        }
        
        .game-over p, .game-win p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes containerPop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .game-container {
                padding: 15px;
                width: 100%;
                max-width: 100%;
                margin: 5px 0;
            }
            
            h1 {
                font-size: 1.5rem;
                margin: 6px 0 10px;
            }
            
            .stats {
                margin-bottom: 10px;
            }
            
            .stat-box {
                min-width: 70px;
                padding: 6px 10px;
            }
            
            .stat-box h3 {
                font-size: 0.7rem;
            }
            
            .stat-box p {
                font-size: 0.9rem;
            }
            
            .game-board {
                height: 300px;
                margin: 6px 0 10px;
            }
            
            button {
                padding: 9px 14px;
                font-size: 0.85rem;
            }
            
            .back-home {
                top: 6px;
                left: 6px;
                width: 26px;
                height: 26px;
                font-size: 12px;
            }
        }
        
        /* æ•™ç¨‹æ¨¡æ€æ¡†æ ·å¼ */
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .tutorial-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .tutorial-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .tutorial-modal.active .tutorial-content {
            transform: scale(1);
        }
        
        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #34495e;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .tutorial-header h2 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .tutorial-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #2c3e50;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .tutorial-close:hover {
            background: rgba(44, 62, 80, 0.1);
            color: #1a252f;
        }
        
        .tutorial-body {
            padding: 20px;
            color: #2c3e50;
        }
        
        .tutorial-section {
            margin-bottom: 20px;
        }
        
        .tutorial-section h3 {
            color: #34495e;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            font-weight: bold;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 5px;
        }
        
        .tutorial-section p {
            margin: 0 0 10px 0;
            line-height: 1.5;
        }
        
        .tutorial-section ul {
            margin: 0 0 10px 0;
            padding-left: 20px;
        }
        
        .tutorial-section li {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        /* ç§»åŠ¨ç«¯æ•™ç¨‹æ¨¡æ€æ¡†ä¼˜åŒ– */
        @media (max-width: 480px) {
            .tutorial-content {
                width: 95%;
                max-height: 90vh;
            }
            
            .tutorial-header {
                padding: 15px;
            }
            
            .tutorial-header h2 {
                font-size: 1.3rem;
            }
            
            .tutorial-body {
                padding: 15px;
            }
            
            .tutorial-section h3 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <a class="back-home" href="../index.html">â†</a>
    <div class="game-container">
        <h1>æ‰“ç –å—</h1>
        <div class="stats">
            <div class="stat-box">
                <h3>å¾—åˆ†</h3>
                <p id="score">0</p>
            </div>
            <div class="stat-box">
                <h3>ç”Ÿå‘½</h3>
                <p id="lives">3</p>
            </div>
            <div class="stat-box">
                <h3>å…³å¡</h3>
                <p id="level">1</p>
            </div>
            <div class="stat-box">
                <h3>æœ€é«˜åˆ†</h3>
                <p id="high-score">0</p>
            </div>
        </div>
        <div class="game-board">
            <canvas id="gameCanvas"></canvas>
            <div class="game-over" id="gameOver">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore">0</span></p>
                <button id="restartBtn">é‡æ–°å¼€å§‹</button>
            </div>
            <div class="game-win" id="gameWin">
                <h2>æ­å–œé€šå…³</h2>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="winScore">0</span></p>
                <button id="nextLevelBtn">ä¸‹ä¸€å…³</button>
            </div>
        </div>
        <div class="controls">
            <div class="buttons">
                <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
                <button id="pauseBtn">æš‚åœ</button>
                <button id="tutorial-btn">ç©æ³•æ•™ç¨‹</button>
            </div>
            <p style="margin-top: 10px; color: #7f8c8d; font-size: 0.85rem;">ä½¿ç”¨ â† â†’ é”®ã€é¼ æ ‡æˆ–æ»‘åŠ¨æ‰‹åŠ¿ç§»åŠ¨æŒ¡æ¿</p>
        </div>
        <div class="gesture-hint" style="margin-top: 10px; color: #7f8c8d; font-size: 0.8rem; text-align: center; display: none;">
            ğŸ’¡ æç¤ºï¼šå·¦å³æ»‘åŠ¨å±å¹•å¯æ§åˆ¶æŒ¡æ¿
        </div>
    </div>

    <!-- æ•™ç¨‹æ¨¡æ€æ¡† -->
    <div id="tutorial-modal" class="tutorial-modal">
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h2>ç©æ³•æ•™ç¨‹</h2>
                <button class="tutorial-close">Ã—</button>
            </div>
            <div class="tutorial-body">
                <div class="tutorial-section">
                    <h3>æ¸¸æˆç›®æ ‡</h3>
                    <p>æ§åˆ¶æŒ¡æ¿åå¼¹å°çƒï¼Œæ‰“ç ´æ‰€æœ‰ç –å—ï¼Œè·å–é«˜åˆ†ï¼</p>
                </div>
                <div class="tutorial-section">
                    <h3>æ“ä½œæ–¹æ³•</h3>
                    <ul>
                        <li>é”®ç›˜ï¼šä½¿ç”¨æ–¹å‘é”®å·¦å³ç§»åŠ¨æŒ¡æ¿</li>
                        <li>é¼ æ ‡ï¼šç§»åŠ¨é¼ æ ‡æ§åˆ¶æŒ¡æ¿ä½ç½®</li>
                        <li>è§¦å±ï¼šåœ¨å±å¹•ä¸Šå·¦å³æ»‘åŠ¨æ§åˆ¶æŒ¡æ¿</li>
                    </ul>
                </div>
                <div class="tutorial-section">
                    <h3>æ¸¸æˆè§„åˆ™</h3>
                    <ul>
                        <li>å°çƒç¢°åˆ°ç –å—ä¼šåå¼¹å¹¶æ¶ˆé™¤ç –å—</li>
                        <li>æ¶ˆé™¤ç –å—è·å¾—åˆ†æ•°</li>
                        <li>å°çƒæ‰å‡ºå±å¹•ä¼šå‡å°‘ç”Ÿå‘½å€¼</li>
                        <li>ç”Ÿå‘½å€¼è€—å°½æ¸¸æˆç»“æŸ</li>
                        <li>æ¶ˆé™¤æ‰€æœ‰ç –å—è¿›å…¥ä¸‹ä¸€å…³</li>
                    </ul>
                </div>
                <div class="tutorial-section">
                    <h3>æŠ€å·§æç¤º</h3>
                    <ul>
                        <li>å°è¯•è®©å°çƒå‡»ä¸­æŒ¡æ¿çš„ä¸åŒä½ç½®ï¼Œæ”¹å˜åå¼¹è§’åº¦</li>
                        <li>ä¼˜å…ˆæ¶ˆé™¤é¡¶éƒ¨çš„ç –å—</li>
                        <li>ä¿æŒæŒ¡æ¿ç§»åŠ¨å¹³ç¨³ï¼Œé¿å…å°çƒå¿«é€Ÿæ”¹å˜æ–¹å‘</li>
                        <li>æ³¨æ„è§‚å¯Ÿå°çƒçš„è¿åŠ¨è½¨è¿¹ï¼Œæå‰é¢„åˆ¤</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/logger.js" defer></script>
    <script src="../js/dataManager.js" defer></script>
    <script src="../js/scoreManager.js" defer></script>
    <script src="../js/audioVibration.js" defer></script>
    <script src="../js/i18n.js" defer></script>
    <script src="../js/lib/hammer.min.js" defer></script>
    <script>
        window.addEventListener('load', () => {

                                

                                // éŸ³æ•ˆå‡½æ•°

                                function playPaddleHitSound() {
                                    if (gameAudioVibration) {
                                        gameAudioVibration.playClickSound();
                                        gameAudioVibration.vibrateShort();
                                    }
                                }

                                function playBrickHitSound() {
                                    if (gameAudioVibration) {
                                        gameAudioVibration.playSuccessSound();
                                        gameAudioVibration.vibrateMedium();
                                    }
                                }

                                function playWallHitSound() {
                                    if (gameAudioVibration) {
                                        gameAudioVibration.playErrorSound();
                                        gameAudioVibration.vibrateShort();
                                    }
                                }

                                function playWinSound() {
                                    if (gameAudioVibration) {
                                        gameAudioVibration.playWinSound();
                                        gameAudioVibration.vibrateSuccess();
                                    }
                                }

                                function playLoseSound() {
                                    if (gameAudioVibration) {
                                        gameAudioVibration.playLoseSound();
                                        gameAudioVibration.vibrateFailure();
                                    }
                                }

                                

                                // è·å–DOMå…ƒç´ 

                                const canvas = document.getElementById('gameCanvas');

                                const ctx = canvas.getContext('2d');

                                const scoreDisplay = document.getElementById('score');

                                const livesDisplay = document.getElementById('lives');

                                const levelDisplay = document.getElementById('level');

                                const highScoreDisplay = document.getElementById('high-score');

                                const finalScoreDisplay = document.getElementById('finalScore');

                                const winScoreDisplay = document.getElementById('winScore');

                                const gameOverScreen = document.getElementById('gameOver');

                                const gameWinScreen = document.getElementById('gameWin');

                                const startBtn = document.getElementById('startBtn');

                                const pauseBtn = document.getElementById('pauseBtn');

                                const restartBtn = document.getElementById('restartBtn');

                                const nextLevelBtn = document.getElementById('nextLevelBtn');

                                

                                // æ¸¸æˆçŠ¶æ€

                                let score = 0;

                                let lives = 3;

                                let level = 1;

                                let gameRunning = false;

                                let gamePaused = false;

                                let animationId = null;

                                let highScore = 0; // åˆå§‹åŒ–ä¸º0

                                            // å¼‚æ­¥åŠ è½½é«˜åˆ†

                                                                    scoreManager.getHighScore('arkanoid', 0).then(loadedHighScore => {

                                                                        highScore = loadedHighScore;

                                                                        highScoreDisplay.textContent = highScore;

                                                                    });

                                

                                // åˆå§‹åŒ–ç”»å¸ƒ

                                

                                                                function initCanvasSize() {

                                

                                                                    const gameBoard = document.querySelector('.game-board');

                                

                                                                    const containerWidth = gameBoard.clientWidth;

                                

                                                                    const containerHeight = gameBoard.clientHeight;

                                

                                

                                

                                                                    canvas.width = containerWidth;

                                

                                                                    canvas.height = containerHeight;

                                

                                                                }

                                

                                

                                

                                                                initCanvasSize();

                                

                                

                                

                                                                // æ·»åŠ roundRectæ–¹æ³•æ”¯æŒ

                                

                                                                if (CanvasRenderingContext2D.prototype.roundRect === undefined) {

                                

                                                                    CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {

                                

                                                                        if (width < 2 * radius) radius = width / 2;

                                

                                                                        if (height < 2 * radius) radius = height / 2;

                                

                                

                                

                                                                        this.beginPath();

                                

                                                                        this.moveTo(x + radius, y);

                                

                                                                        this.lineTo(x + width - radius, y);

                                

                                                                        this.quadraticCurveTo(x + width, y, x + width, y + radius);

                                

                                                                        this.lineTo(x + width, y + height - radius);

                                

                                                                        this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);

                                

                                                                        this.lineTo(x + radius, y + height);

                                

                                                                        this.quadraticCurveTo(x, y + height, x, y + height - radius);

                                

                                                                        this.lineTo(x, y + radius);

                                

                                                                        this.quadraticCurveTo(x, y, x + radius, y);

                                

                                                                        this.closePath();

                                

                                                                        return this;

                                

                                                                    };

                                

                                                                }

                                

                                

                                

                                                                // æ¸¸æˆå¯¹è±¡ï¼ˆåœ¨canvasåˆå§‹åŒ–ååˆ›å»ºï¼‰

                                

                                                                let ball;

                                

                                                                let paddle;

                                

                                

                                

                                                                function initGameObjects() {

                                

                                                                    ball = {

                                

                                                                        x: canvas.width / 2,

                                

                                                                        y: canvas.height - 50,

                                

                                                                        radius: 8,

                                

                                                                        dx: 4,

                                

                                                                        dy: -4,

                                

                                                                        speed: 4,

                                

                                                                        reset: function() {

                                

                                                                            this.x = canvas.width / 2;

                                

                                                                            this.y = canvas.height - 50;

                                

                                                                            this.dx = 4 * (Math.random() > 0.5 ? 1 : -1);

                                

                                                                            this.dy = -4;

                                

                                                                        }

                                

                                                                    };

                                

                                

                                

                                                                    paddle = {

                                

                                                                        width: Math.min(80, canvas.width * 0.2),

                                

                                                                        height: 12,

                                

                                                                        x: (canvas.width - Math.min(80, canvas.width * 0.2)) / 2,

                                

                                                                        speed: 8,

                                

                                                                        moveLeft: function() {

                                

                                                                            this.x = Math.max(0, this.x - this.speed);

                                

                                                                        },

                                

                                                                        moveRight: function() {

                                

                                                                            this.x = Math.min(canvas.width - this.width, this.x + this.speed);

                                

                                                                        }

                                

                                                                    };

                                

                                                                }

                                

                                // ç –å—ç³»ç»Ÿ

                                const brick = {

                                    rowCount: 5,

                                    colCount: 8,

                                    width: 0,

                                    height: 20,

                                    padding: 4,

                                    offsetTop: 50,

                                    offsetLeft: 10,

                                    init: function() {

                                        this.width = (canvas.width - (this.offsetLeft * 2) - (this.padding * (this.colCount + 1))) / this.colCount;

                                        this.height = Math.min(20, (canvas.height * 0.25) / this.rowCount);

                                    },

                                    rows: []

                                };

                                

                                // åˆå§‹åŒ–ç –å—

                                function initBricks() {

                                    brick.init();

                                    brick.rows = [];

                                    

                                    for (let r = 0; r < brick.rowCount; r++) {

                                        brick.rows[r] = [];

                                        for (let c = 0; c < brick.colCount; c++) {

                                            brick.rows[r][c] = {

                                                x: c * (brick.width + brick.padding) + brick.offsetLeft,

                                                y: r * (brick.height + brick.padding) + brick.offsetTop,

                                                status: true,

                                                color: getBrickColor(r)

                                            };

                                        }

                                    }

                                }

                                

                                // è·å–ç –å—é¢œè‰²

                                function getBrickColor(row) {

                                    const colors = [

                                        "#e74c3c", // çº¢è‰²

                                        "#e67e22", // æ©™è‰²

                                        "#f1c40f", // é»„è‰²

                                        "#2ecc71", // ç»¿è‰²

                                        "#3498db"  // è“è‰²

                                    ];

                                    return colors[row % colors.length];

                                }

                                

                                // ç»˜åˆ¶å‡½æ•°

                                function drawBall() {
                                    // åˆ›å»ºå¸¦æœ‰å…‰æ³½æ•ˆæœçš„çƒ
                                    ctx.beginPath();
                                    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                                    
                                    // åˆ›å»ºå¾„å‘æ¸å˜
                                    const gradient = ctx.createRadialGradient(
                                        ball.x - ball.radius/3, ball.y - ball.radius/3, 1,
                                        ball.x, ball.y, ball.radius
                                    );
                                    gradient.addColorStop(0, "#ffffff");
                                    gradient.addColorStop(0.3, "#e74c3c");
                                    gradient.addColorStop(1, "#c0392b");
                                    
                                    ctx.fillStyle = gradient;
                                    ctx.fill();
                                    
                                    // æ·»åŠ é«˜å…‰æ•ˆæœ
                                    ctx.beginPath();
                                    ctx.arc(
                                        ball.x - ball.radius/3, 
                                        ball.y - ball.radius/3, 
                                        ball.radius/3, 
                                        0, 
                                        Math.PI * 2
                                    );
                                    ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                                    ctx.fill();
                                    
                                    ctx.closePath();
                                    
                                    // æ·»åŠ è½¨è¿¹æ•ˆæœï¼ˆå¯é€‰ï¼‰
                                    if (gameRunning && !gamePaused) {
                                        ctx.beginPath();
                                        ctx.arc(ball.x - ball.dx * 0.3, ball.y - ball.dy * 0.3, ball.radius * 0.7, 0, Math.PI * 2);
                                        ctx.fillStyle = "rgba(231, 76, 60, 0.3)";
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                }

                                

                                function drawPaddle() {
                                    // ç»˜åˆ¶æŒ¡æ¿ä¸»ä½“
                                    ctx.beginPath();
                                    ctx.roundRect(paddle.x, canvas.height - paddle.height, paddle.width, paddle.height, 5);
                                    
                                    // åˆ›å»ºçº¿æ€§æ¸å˜
                                    const gradient = ctx.createLinearGradient(
                                        paddle.x, canvas.height - paddle.height,
                                        paddle.x, canvas.height
                                    );
                                    gradient.addColorStop(0, "#3498db");
                                    gradient.addColorStop(1, "#2980b9");
                                    
                                    ctx.fillStyle = gradient;
                                    ctx.fill();
                                    
                                    // æ·»åŠ è¾¹æ¡†
                                    ctx.strokeStyle = "#1f618d";
                                    ctx.lineWidth = 2;
                                    ctx.stroke();
                                    
                                    // æ·»åŠ é«˜å…‰æ•ˆæœ
                                    ctx.beginPath();
                                    ctx.roundRect(paddle.x + 2, canvas.height - paddle.height + 2, paddle.width - 4, 4, 2);
                                    ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
                                    ctx.fill();
                                    
                                    ctx.closePath();
                                }

                                

                                // ç –å—ç ´ç¢åŠ¨ç”»ç³»ç»Ÿ
                                const brickParticles = [];

                                function createBrickParticles(x, y, color) {
                                    for (let i = 0; i < 8; i++) {
                                        brickParticles.push({
                                            x: x,
                                            y: y,
                                            size: Math.random() * 4 + 2,
                                            speedX: (Math.random() - 0.5) * 6,
                                            speedY: (Math.random() - 0.5) * 6,
                                            color: color,
                                            life: 20
                                        });
                                    }
                                }

                                function updateBrickParticles() {
                                    for (let i = brickParticles.length - 1; i >= 0; i--) {
                                        const p = brickParticles[i];
                                        p.x += p.speedX;
                                        p.y += p.speedY;
                                        p.life--;
                                        
                                        if (p.life <= 0) {
                                            brickParticles.splice(i, 1);
                                        }
                                    }
                                }

                                function drawBrickParticles() {
                                    for (const p of brickParticles) {
                                        ctx.globalAlpha = p.life / 20;
                                        ctx.fillStyle = p.color;
                                        ctx.beginPath();
                                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                                        ctx.fill();
                                    }
                                    ctx.globalAlpha = 1.0;
                                }

                                function drawBricks() {
                                    for (let r = 0; r < brick.rowCount; r++) {
                                        for (let c = 0; c < brick.colCount; c++) {
                                            const b = brick.rows[r][c];
                                            if (b.status) {
                                                ctx.beginPath();
                                                ctx.roundRect(b.x, b.y, brick.width, brick.height, 3);
                                                ctx.fillStyle = b.color;
                                                ctx.fill();
                                                ctx.strokeStyle = "#2c3e50";
                                                ctx.lineWidth = 1;
                                                ctx.stroke();
                                                ctx.closePath();
                                                
                                                // æ·»åŠ ç –å—å…‰æ³½æ•ˆæœ
                                                ctx.beginPath();
                                                ctx.roundRect(b.x + 2, b.y + 2, brick.width - 4, 4, 2);
                                                ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
                                                ctx.fill();
                                                ctx.closePath();
                                            }
                                        }
                                    }
                                }

                        

                                                        // ç¢°æ’æ£€æµ‹

                                                        function detectCollisions() {
                                                            // ç –å—ç¢°æ’
                                                            for (let r = 0; r < brick.rowCount; r++) {
                                                                for (let c = 0; c < brick.colCount; c++) {
                                                                    const b = brick.rows[r][c];
                                                                    if (b.status) {
                                                                        if (
                                                                            ball.x + ball.radius > b.x && 
                                                                            ball.x - ball.radius < b.x + brick.width && 
                                                                            ball.y + ball.radius > b.y && 
                                                                            ball.y - ball.radius < b.y + brick.height
                                                                        ) {
                                                                            b.status = false;
                                                                            // æ ¹æ®çƒä¸ç –å—çš„ç¢°æ’æ–¹å‘è°ƒæ•´åå¼¹æ–¹å‘
                                                                            const ballCenterX = ball.x;
                                                                            const ballCenterY = ball.y;
                                                                            const brickCenterX = b.x + brick.width / 2;
                                                                            const brickCenterY = b.y + brick.height / 2;
                                                                            
                                                                            // è®¡ç®—çƒå¿ƒåˆ°ç –å—ä¸­å¿ƒçš„å‘é‡
                                                                            const dx = ballCenterX - brickCenterX;
                                                                            const dy = ballCenterY - brickCenterY;
                                                                            
                                                                            // æ ¹æ®ç¢°æ’æ–¹å‘è°ƒæ•´åå¼¹
                                                                            if (Math.abs(dx) > Math.abs(dy)) {
                                                                                // æ°´å¹³æ–¹å‘ç¢°æ’
                                                                                ball.dx = -ball.dx;
                                                                            } else {
                                                                                // å‚ç›´æ–¹å‘ç¢°æ’
                                                                                ball.dy = -ball.dy;
                                                                            }
                                                                            
                                                                            score += 10;
                                                                            scoreDisplay.textContent = score;
                                                                            
                                                                            // æ£€æŸ¥é«˜åˆ†è®°å½•
                                                                                                    if (score > highScore) {
                                                                                                        highScore = score;
                                                                                                        scoreManager.updateHighScore('arkanoid', highScore);
                                                                                                        highScoreDisplay.textContent = highScore;
                                                                                                    }                                                                            
                                                                            // åˆ›å»ºç ´ç¢ç²’å­æ•ˆæœ
                                                                            createBrickParticles(
                                                                                b.x + brick.width / 2, 
                                                                                b.y + brick.height / 2, 
                                                                                b.color
                                                                            );
                                                                            
                                                                            playBrickHitSound();
                                                                            
                                                                            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç –å—éƒ½è¢«æ¸…é™¤
                                                                            let allBricksBroken = true;
                                                                            for (let r2 = 0; r2 < brick.rowCount; r2++) {
                                                                                for (let c2 = 0; c2 < brick.colCount; c2++) {
                                                                                    if (brick.rows[r2][c2].status) {
                                                                                        allBricksBroken = false;
                                                                                        break;
                                                                                    }
                                                                                }
                                                                                if (!allBricksBroken) break;
                                                                            }
                                                                            
                                                                            if (allBricksBroken) {
                                                                                levelUp();
                                                                            }
                                                                            
                                                                            return true; // ç –å—ç¢°æ’å·²å¤„ç†
                                                                        }
                                                                    }
                                                                }
                                                            }

                        

                                                            

                        

                                                            // æŒ¡æ¿ç¢°æ’

                        

                                                            if (

                        

                                                                ball.y + ball.radius > canvas.height - paddle.height &&

                        

                                                                ball.y - ball.radius < canvas.height &&

                        

                                                                ball.x + ball.radius > paddle.x &&

                        

                                                                ball.x - ball.radius < paddle.x + paddle.width

                        

                                                            ) {

                        

                                                                // æ ¹æ®çƒå‡»ä¸­æŒ¡æ¿çš„ä½ç½®è°ƒæ•´åå¼¹è§’åº¦

                        

                                                                const hitPos = (ball.x - (paddle.x + paddle.width / 2)) / (paddle.width / 2);

                        

                                                                ball.dx = hitPos * 5; // æ ¹æ®å‡»ä¸­ä½ç½®è°ƒæ•´æ°´å¹³é€Ÿåº¦

                        

                                                                ball.dy = -Math.abs(ball.dy); // ç¡®ä¿çƒå‘ä¸Šåå¼¹

                        

                                                                playPaddleHitSound();

                        

                                                                return true; // æŒ¡æ¿ç¢°æ’å·²å¤„ç†

                        

                                                            }

                        

                                                            

                        

                                                            // è¾¹ç•Œç¢°æ’

                        

                                                            // å·¦å³è¾¹ç•Œ

                        

                                                            if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {

                        

                                                                ball.dx = -ball.dx;

                        

                                                                playWallHitSound();

                        

                                                            }

                        

                                                            

                        

                                                            // ä¸Šè¾¹ç•Œ

                        

                                                            if (ball.y - ball.radius < 0) {

                        

                                                                ball.dy = -ball.dy;

                        

                                                                playWallHitSound();

                        

                                                            }

                        

                                                            

                        

                                                            // ä¸‹è¾¹ç•Œï¼ˆå¤±å»ç”Ÿå‘½å€¼ï¼‰

                        

                                                            if (ball.y + ball.radius > canvas.height) {

                        

                                                                lives--;

                        

                                                                livesDisplay.textContent = lives;

                        

                                                                

                        

                                                                if (lives <= 0) {

                        

                                                                    gameOver();

                        

                                                                } else {

                        

                                                                    resetBall();

                        

                                                                }

                        

                                                            }

                        

                                                            

                        

                                                            return false; // æ²¡æœ‰ç –å—æˆ–æŒ¡æ¿ç¢°æ’

                        

                                                        }

                        

                        // é‡ç½®çƒ

                        function resetBall() {

                            ball.reset();

                        }

                        

                        // æ¸¸æˆå¾ªç¯
                        function gameLoop() {
                            if (!gameRunning || gamePaused) {
                                animationId = requestAnimationFrame(gameLoop);
                                return;
                            }
                            
                            // æ¸…ç©ºç”»å¸ƒ
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            
                            // ç§»åŠ¨çƒ
                            ball.x += ball.dx;
                            ball.y += ball.dy;
                            
                            // æ£€æµ‹ç¢°æ’
                            detectCollisions();
                            
                            // æ›´æ–°ç²’å­ç³»ç»Ÿ
                            updateBrickParticles();
                            
                            // ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
                            drawBricks();
                            drawBrickParticles(); // ç»˜åˆ¶ç ´ç¢ç²’å­
                            drawBall();
                            drawPaddle();
                            
                            // æš‚åœæ˜¾ç¤º
                            if (gamePaused) {
                                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                ctx.font = 'bold 30px Arial';
                                ctx.fillStyle = 'white';
                                ctx.textAlign = 'center';
                                ctx.fillText('æ¸¸æˆæš‚åœ', canvas.width/2, canvas.height/2);
                            }
                            
                            animationId = requestAnimationFrame(gameLoop);
                        }

                        

                        // æ¸¸æˆçŠ¶æ€å‡½æ•°

                        function startGame() {

                            if (gameRunning) {

                                resetGame();

                                return;

                            }

                            

                            gameRunning = true;

                            gamePaused = false;

                            startBtn.textContent = "é‡æ–°å¼€å§‹";

                            pauseBtn.textContent = "æš‚åœ";

                            gameLoop();

                        }

                        

                        function togglePause() {

                            if (!gameRunning) return;

                            

                            gamePaused = !gamePaused;

                            pauseBtn.textContent = gamePaused ? "ç»§ç»­" : "æš‚åœ";

                        }

                        

                        function gameOver() {

                            gameRunning = false;

                            cancelAnimationFrame(animationId);

                            finalScoreDisplay.textContent = score;

                            gameOverScreen.style.display = "flex";

                            // è®°å½•æ¸¸æˆç»“æœ
                            scoreManager.recordGameResult('arkanoid', 'loss', score);

                            playLoseSound();

                        }

                        

                        function levelUp() {

                            gameRunning = false;

                            cancelAnimationFrame(animationId);

                            winScoreDisplay.textContent = score;

                            gameWinScreen.style.display = "flex";

                            // è®°å½•æ¸¸æˆç»“æœ
                            scoreManager.recordGameResult('arkanoid', 'win', score);

                            playWinSound();

                        }

                        

                        function nextLevel() {

                            level++;

                            levelDisplay.textContent = level;

                            initBricks();

                            resetBall();

                            gameWinScreen.style.display = "none";

                            gameRunning = true;

                            gamePaused = false;

                            gameLoop();

                        }

                        

                        function resetGame() {

                            if (animationId) {

                                cancelAnimationFrame(animationId);

                            }

                            

                            // é‡ç½®æ¸¸æˆçŠ¶æ€

                            score = 0;

                            lives = 3;

                            level = 1;

                            

                            scoreDisplay.textContent = score;

                            livesDisplay.textContent = lives;

                            levelDisplay.textContent = level;

                            

                            initBricks();

                            resetBall();

                            

                            gameOverScreen.style.display = "none";

                            gameWinScreen.style.display = "none";

                            

                            gameRunning = false;

                            gamePaused = false;

                            startBtn.textContent = "å¼€å§‹æ¸¸æˆ";

                            pauseBtn.textContent = "æš‚åœ";

                            

                            // é‡æ–°ç»˜åˆ¶åˆå§‹ç”»é¢

                            ctx.clearRect(0, 0, canvas.width, canvas.height);

                            drawBricks();

                            drawBall();

                            drawPaddle();

                        }

                        

                        // äº‹ä»¶ç›‘å¬å™¨

                        startBtn.addEventListener('click', startGame);

                        pauseBtn.addEventListener('click', togglePause);

                        restartBtn.addEventListener('click', () => {

                            gameOverScreen.style.display = "none";

                            resetGame();

                        });

                        nextLevelBtn.addEventListener('click', nextLevel);

                        

                        // é”®ç›˜æ§åˆ¶

                        document.addEventListener('keydown', (e) => {

                            if (!gameRunning || gamePaused) return;

                            

                            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {

                                paddle.moveLeft();

                            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {

                                paddle.moveRight();

                            } else if (e.key === ' ') {  // ç©ºæ ¼é”®æš‚åœ

                                togglePause();

                            }

                        });

                        

                        // é¼ æ ‡æ§åˆ¶

                        canvas.addEventListener('mousemove', (e) => {

                            if (!gameRunning || gamePaused) return;

                            

                            const rect = canvas.getBoundingClientRect();

                            const relativeX = e.clientX - rect.left;

                            paddle.x = Math.max(0, Math.min(relativeX - paddle.width / 2, canvas.width - paddle.width));

                        });

                        

                        // è§¦æ‘¸æ§åˆ¶
                        canvas.addEventListener('touchmove', (e) => {
                            if (!gameRunning || gamePaused) return;
                            
                            e.preventDefault();
                            const rect = canvas.getBoundingClientRect();
                            const relativeX = e.touches[0].clientX - rect.left;
                            paddle.x = Math.max(0, Math.min(relativeX - paddle.width / 2, canvas.width - paddle.width));
                        }, { passive: false });
                        
                        // è§¦æ‘¸å¼€å§‹äº‹ä»¶ï¼Œç”¨äºç§»åŠ¨ç«¯ä½“éªŒä¼˜åŒ–
                        canvas.addEventListener('touchstart', (e) => {
                            if (!gameRunning) {
                                startGame(); // å¦‚æœæ¸¸æˆæœªå¼€å§‹ï¼Œè§¦æ‘¸å¼€å§‹æ—¶è‡ªåŠ¨å¼€å§‹æ¸¸æˆ
                            }
                        });

                        

                                        // Hammer.js æ‰‹åŠ¿æ§åˆ¶

                        

                                        const hammerManager = new Hammer.Manager(canvas);

                        

                                        hammerManager.add(new Hammer.Swipe({ direction: Hammer.DIRECTION_HORIZONTAL, threshold: 10, velocity: 0.3 }));

                        

                                        

                        

                                        hammerManager.on('swipeleft', (e) => {

                        

                                            if (gameRunning && !gamePaused) {

                        

                                                paddle.moveLeft();

                        

                                            }

                        

                                            e.preventDefault();

                        

                                        });

                        

                                        

                        

                                        hammerManager.on('swiperight', (e) => {

                        

                                            if (gameRunning && !gamePaused) {

                        

                                                paddle.moveRight();

                        

                                            }

                        

                                            e.preventDefault();

                        

                                        });

                        

                        // çª—å£å¤§å°è°ƒæ•´

                        window.addEventListener('resize', () => {

                            initCanvasSize();

                            initGameObjects(); // é‡æ–°åˆå§‹åŒ–æ¸¸æˆå¯¹è±¡

                            initBricks(); // é‡æ–°åˆå§‹åŒ–ç –å—å¸ƒå±€

                            resetBall();

                            

                            // é‡æ–°ç»˜åˆ¶åˆå§‹ç”»é¢

                            if (!gameRunning) {

                                ctx.clearRect(0, 0, canvas.width, canvas.height);

                                drawBricks();

                                drawBall();

                                drawPaddle();

                            }

                        });

                        

                        // åˆå§‹åŒ–æ¸¸æˆ

                        initGameObjects();

                        initBricks();

                        resetBall();

                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        drawBricks();

                        drawBall();

                        drawPaddle();
                        
                        // æ•™ç¨‹æ¨¡æ€æ¡†é€»è¾‘
                        const tutorialModal = document.getElementById('tutorial-modal');
                        const tutorialBtn = document.getElementById('tutorial-btn');
                        const tutorialClose = document.querySelector('.tutorial-close');
                        
                        if (tutorialBtn) {
                            tutorialBtn.addEventListener('click', () => {
                                tutorialModal.classList.add('active');
                            });
                        }
                        
                        if (tutorialClose) {
                            tutorialClose.addEventListener('click', () => {
                                tutorialModal.classList.remove('active');
                            });
                        }
                        
                        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                        tutorialModal.addEventListener('click', (e) => {
                            if (e.target === tutorialModal) {
                                tutorialModal.classList.remove('active');
                            }
                        });
                        
                        // åˆå§‹åŒ–æ¸¸æˆç†Ÿæ‚‰åº¦ç³»ç»Ÿ
                        if (window.gameFamiliaritySystem) {
                            window.gameFamiliaritySystem.init('arkanoid', 'æ‰“ç –å—');
                        }

        });

                </script>
    <script src="../js/gameFamiliarity.js" defer></script>
</body>
</html>