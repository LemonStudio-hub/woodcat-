<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«é›· - æœ¨å¤´çŒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 100%;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            animation: containerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        h1 {
            color: #2c3e50;
            margin: 10px 0 15px;
            text-align: center;
            font-size: 1.6rem;
            font-weight: 600;
            animation: fadeIn 0.6s ease-out;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            animation: slideIn 0.5s ease-out 0.1s both;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-box .label {
            color: #7f8c8d;
            font-size: 0.8rem;
        }
        
        .stat-box .value {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            aspect-ratio: 1/1;
            width: 100%;
            max-width: 380px;
            min-width: 280px;
            border: 2px solid #7f8c8d;
            background: #7f8c8d;
            margin-bottom: 15px;
            padding: 4px;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }

        .cell {
            width: 100%;
            height: 100%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            border: 2px outset #bdc3c7;
            aspect-ratio: 1/1;
            position: relative;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            min-width: 0;
            min-height: 0;
        }
        
        .cell.revealed {
            background: #ecf0f1;
            border: 1px solid #95a5a6;
            transform: scale(0.95);
            animation: reveal 0.2s ease-out;
        }
        
        .cell.mine {
            background: #e74c3c;
        }
        
        .cell.flagged::before {
            content: 'ğŸš©';
            font-size: 16px;
            animation: flagPulse 1s infinite alternate;
        }
        
        .cell.marked-as-mine::before {
            content: 'ğŸš©';
            font-size: 16px;
            animation: flagPulse 1s infinite alternate;
        }
        
        .cell-0 { color: transparent; }
        .cell-1 { color: #3498db; }
        .cell-2 { color: #2ecc71; }
        .cell-3 { color: #e74c3c; }
        .cell-4 { color: #9b59b6; }
        .cell-5 { color: #e67e22; }
        .cell-6 { color: #1abc9c; }
        .cell-7 { color: #34495e; }
        .cell-8 { color: #d35400; }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 100%;
            animation: slideIn 0.5s ease-out 0.3s both;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }

        .difficulty-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .difficulty-btn.active {
            background: #3498db;
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }

        button {
            padding: 10px 16px;
            font-size: 0.9rem;
            background: #7f8c8d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background: #95a5a6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .back-home {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #34495e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            text-decoration: none;
        }
        
        .back-home:hover {
            background: #2c3e50;
            transform: scale(1.15) rotate(-10deg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .back-home:active {
            transform: scale(1.05);
        }
        
        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes containerPop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        @keyframes reveal {
            0% { transform: scale(0.8); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes flagPulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }
        
        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }
        
        @keyframes winPulse {
            0% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.5); }
            50% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.8); }
            100% { box-shadow: 0 0 5px rgba(46, 204, 113, 0.5); }
        }
        
        .explosion {
            animation: explode 0.5s ease-out;
        }
        
        .win-glow {
            animation: winPulse 1.5s infinite;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
                max-width: 95%;
                margin: 10px auto;
            }

            .game-board {
                max-width: 360px;
                width: 100%;
            }

            .difficulty-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .stats {
                flex-wrap: wrap;
                gap: 8px;
            }

            .stat-box {
                flex: 1 1 40%;
                min-width: 80px;
            }
        }

        /* å°å±æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.4rem;
                margin: 6px 0 12px;
            }

            .game-container {
                padding: 12px;
                max-width: 100%;
                margin: 5px auto;
            }

            .game-board {
                max-width: 340px;
                min-width: 260px;
                padding: 3px;
            }

            .cell {
                font-size: 11px;
                border-width: 1px;
            }

            .cell.flagged::before,
            .cell.marked-as-mine::before {
                font-size: 14px;
            }

            .difficulty-selector {
                gap: 6px;
            }

            .difficulty-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                border-radius: 4px;
            }

            .stat-box .label {
                font-size: 0.7rem;
            }

            .stat-box .value {
                font-size: 0.95rem;
            }

            button {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .back-home {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            h1 {
                font-size: 1.2rem;
                margin: 5px 0 10px;
            }

            .game-container {
                padding: 10px;
            }

            .game-board {
                max-width: 300px;
                min-width: 240px;
            }

            .cell {
                font-size: 10px;
            }

            .cell.flagged::before,
            .cell.marked-as-mine::before {
                font-size: 12px;
            }

            .difficulty-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }

            .stat-box {
                flex: 1 1 30%;
                min-width: 60px;
            }

            .stat-box .label {
                font-size: 0.65rem;
            }

            .stat-box .value {
                font-size: 0.85rem;
            }

            button {
                padding: 7px 12px;
                font-size: 0.8rem;
            }
        }

        /* å¹³æ¿è®¾å¤‡ä¼˜åŒ– */
        @media (min-width: 769px) and (max-width: 1024px) {
            .game-container {
                max-width: 500px;
            }

            .game-board {
                max-width: 450px;
            }
        }

        /* æ¡Œé¢ç«¯ä¼˜åŒ– */
        @media (min-width: 1025px) {
            .game-container {
                max-width: 550px;
            }

            .game-board {
                max-width: 500px;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            body {
                flex-direction: row;
                padding: 10px;
            }

            .game-container {
                flex-direction: row;
                max-width: 100%;
                margin: 0;
            }

            .game-board {
                max-width: 300px;
                margin-right: 20px;
                margin-bottom: 0;
            }
        }
        
        /* æ•™ç¨‹æ¨¡æ€æ¡†æ ·å¼ */
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .tutorial-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .tutorial-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .tutorial-modal.active .tutorial-content {
            transform: scale(1);
        }
        
        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #3498db;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .tutorial-header h2 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .tutorial-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #2c3e50;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .tutorial-close:hover {
            background: rgba(44, 62, 80, 0.1);
            color: #1a252f;
        }
        
        .tutorial-body {
            padding: 20px;
            color: #2c3e50;
        }
        
        .tutorial-section {
            margin-bottom: 20px;
        }
        
        .tutorial-section h3 {
            color: #3498db;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            font-weight: bold;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 5px;
        }
        
        .tutorial-section p {
            margin: 0 0 10px 0;
            line-height: 1.5;
        }
        
        .tutorial-section ul {
            margin: 0 0 10px 0;
            padding-left: 20px;
        }
        
        .tutorial-section li {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        /* ç§»åŠ¨ç«¯æ•™ç¨‹æ¨¡æ€æ¡†ä¼˜åŒ– */
        @media (max-width: 480px) {
            .tutorial-content {
                width: 95%;
                max-height: 90vh;
            }
            
            .tutorial-header {
                padding: 15px;
            }
            
            .tutorial-header h2 {
                font-size: 1.3rem;
            }
            
            .tutorial-body {
                padding: 15px;
            }
            
            .tutorial-section h3 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <a class="back-home" href="../index.html">â†</a>
    <div class="game-container">
        <h1>æ‰«é›·</h1>
        <div class="stats">
            <div class="stat-box">
                <div class="label">å‰©ä½™é›·æ•°</div>
                <div class="value" id="mines-count">15</div>
            </div>
            <div class="stat-box">
                <div class="label">å·²æ ‡è®°</div>
                <div class="value" id="flags-count">0</div>
            </div>
            <div class="stat-box">
                <div class="label">æ—¶é—´</div>
                <div class="value" id="timer">0</div>
            </div>
            <div class="stat-box">
                <div class="label">æœ€ä½³</div>
                <div class="value" id="best-time">-</div>
            </div>
        </div>
        <div class="game-board" id="board"></div>
        <div class="controls">
            <div class="difficulty-selector">
                <button class="difficulty-btn active" data-difficulty="easy">ç®€å• (10Ã—10)</button>
                <button class="difficulty-btn" data-difficulty="medium">ä¸­ç­‰ (15Ã—15)</button>
                <button class="difficulty-btn" data-difficulty="hard">å›°éš¾ (20Ã—20)</button>
            </div>
            <div class="buttons">
                <button id="resetBtn">æ–°æ¸¸æˆ</button>
                <button id="tutorial-btn">ç©æ³•æ•™ç¨‹</button>
            </div>
        </div>
    </div>

    <!-- æ•™ç¨‹æ¨¡æ€æ¡† -->
    <div id="tutorial-modal" class="tutorial-modal">
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h2>ç©æ³•æ•™ç¨‹</h2>
                <button class="tutorial-close">Ã—</button>
            </div>
            <div class="tutorial-body">
                <div class="tutorial-section">
                    <h3>æ¸¸æˆç›®æ ‡</h3>
                    <p>é€šè¿‡æ ‡è®°å’Œæ’é™¤ï¼Œæ‰¾å‡ºæ‰€æœ‰éšè—çš„åœ°é›·ï¼ŒåŒæ—¶æ­å¼€æ‰€æœ‰å®‰å…¨çš„æ ¼å­ï¼</p>
                </div>
                <div class="tutorial-section">
                    <h3>æ“ä½œæ–¹æ³•</h3>
                    <ul>
                        <li>ç‚¹å‡»ï¼šæ­å¼€æ ¼å­ï¼Œæ˜¾ç¤ºä¸‹æ–¹å†…å®¹</li>
                        <li>å³é”®ç‚¹å‡»ï¼ˆPCï¼‰æˆ–é•¿æŒ‰ï¼ˆè§¦å±ï¼‰ï¼šæ ‡è®°å¯èƒ½å­˜åœ¨åœ°é›·çš„æ ¼å­</li>
                    </ul>
                </div>
                <div class="tutorial-section">
                    <h3>æ¸¸æˆè§„åˆ™</h3>
                    <ul>
                        <li>æ•°å­—æ˜¾ç¤ºå‘¨å›´8ä¸ªæ ¼å­ä¸­çš„åœ°é›·æ•°é‡</li>
                        <li>è¸©åˆ°åœ°é›·æ¸¸æˆç»“æŸ</li>
                        <li>æ­å¼€æ‰€æœ‰éé›·æ ¼å­æˆ–æ­£ç¡®æ ‡è®°æ‰€æœ‰åœ°é›·è·èƒœ</li>
                        <li>ä¸åŒéš¾åº¦å¯¹åº”ä¸åŒå¤§å°çš„æ£‹ç›˜å’Œåœ°é›·æ•°é‡</li>
                    </ul>
                </div>
                <div class="tutorial-section">
                    <h3>æŠ€å·§æç¤º</h3>
                    <ul>
                        <li>ä»è§’è½æˆ–è¾¹ç¼˜å¼€å§‹ï¼Œå‡å°‘è¸©åˆ°åœ°é›·çš„æ¦‚ç‡</li>
                        <li>åˆ©ç”¨æ•°å­—æ¨æ–­å‘¨å›´åœ°é›·çš„ä½ç½®</li>
                        <li>å½“æ•°å­—ä¸å‘¨å›´æœªæ­å¼€æ ¼å­æ•°ç›¸ç­‰æ—¶ï¼Œè¿™äº›æ ¼å­éƒ½æ˜¯åœ°é›·</li>
                        <li>åˆç†ä½¿ç”¨æ ‡è®°åŠŸèƒ½ï¼Œé¿å…é‡å¤æ€è€ƒ</li>
                        <li>ä¿æŒå†·é™ï¼Œé€æ­¥åˆ†ææ¯ä¸ªåŒºåŸŸ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/logger.js"></script>
    <script src="../js/dataManager.js"></script>
    <script src="../js/scoreManager.js"></script>
    <script src="../js/i18n.js"></script>
    <script>
        // æ‰«é›·æ ¸å¿ƒæ¸¸æˆé€»è¾‘
        document.addEventListener('DOMContentLoaded', () => {
            // æ¸¸æˆéš¾åº¦é…ç½®
            const DIFFICULTY_LEVELS = {
                easy: { rows: 10, cols: 10, mines: 15, name: 'ç®€å•' },
                medium: { rows: 15, cols: 15, mines: 40, name: 'ä¸­ç­‰' },
                hard: { rows: 20, cols: 20, mines: 80, name: 'å›°éš¾' }
            };

            let currentDifficulty = 'easy';
            let rows, cols, mines;
            let board = [];
            let revealed = 0;
            let gameOver = false;
            let gameStarted = false;
            let timerInterval;
            let seconds = 0;
            let flags = 0; // å·²æ ‡è®°çš„æ——å­æ•°é‡
            let correctFlags = 0; // æ­£ç¡®æ ‡è®°çš„é›·æ•°

            // è®¾ç½®éš¾åº¦
            function setDifficulty(difficulty) {
                currentDifficulty = difficulty;
                const config = DIFFICULTY_LEVELS[difficulty];
                rows = config.rows;
                cols = config.cols;
                mines = config.mines;

                // æ›´æ–°éš¾åº¦æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.difficulty === difficulty) {
                        btn.classList.add('active');
                    }
                });

                // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                initGame();

                // åŠ è½½å½“å‰éš¾åº¦çš„æœ€ä½³æ—¶é—´
                loadBestTime();
            }

            // åŠ è½½å½“å‰éš¾åº¦çš„æœ€ä½³æ—¶é—´
            function loadBestTime() {
                const key = `minesweeper_${currentDifficulty}`;
                scoreManager.getHighScore(key, Infinity).then(loadedBestTime => {
                    bestTime = loadedBestTime;
                    document.getElementById('best-time').textContent = bestTime === Infinity ? '-' : bestTime;
                });
            }

            // åˆå§‹åŒ–æ¸¸æˆ
            function initGame() {
                const config = DIFFICULTY_LEVELS[currentDifficulty];
                rows = config.rows;
                cols = config.cols;
                mines = config.mines;

                // é‡ç½®æ¸¸æˆçŠ¶æ€
                board = [];
                revealed = 0;
                gameOver = false;
                gameStarted = false;
                seconds = 0;
                flags = 0; // é‡ç½®æ ‡è®°æ•°
                correctFlags = 0; // é‡ç½®æ­£ç¡®æ ‡è®°æ•°

                // æ¸…é™¤è®¡æ—¶å™¨
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                // åˆ›å»ºæ¸¸æˆæ¿
                createBoard();

                // æ›´æ–°UI
                document.getElementById('mines-count').textContent = mines;
                document.getElementById('flags-count').textContent = flags;
                document.getElementById('timer').textContent = seconds;
            }
            
            // åˆ›å»ºæ¸¸æˆæ¿
            function createBoard() {
                const boardElement = document.getElementById('board');
                boardElement.innerHTML = '';
                boardElement.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                boardElement.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

                // æ ¹æ®éš¾åº¦å’Œå±å¹•å°ºå¯¸åŠ¨æ€è°ƒæ•´æ¸¸æˆæ¿å¤§å°
                adjustBoardSize();

                // åˆå§‹åŒ–äºŒç»´æ•°ç»„
                board = Array.from({ length: rows }, () =>
                    Array.from({ length: cols }, () => ({
                        isMine: false,
                        isRevealed: false,
                        isFlagged: false,
                        neighborCount: 0
                    }))
                );

                // åˆ›å»ºæ ¼å­å…ƒç´ 
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.x = x;
                        cell.dataset.y = y;

                        // è§¦æ‘¸å¼€å§‹äº‹ä»¶ - ç”¨äºæ£€æµ‹é•¿æŒ‰
                        let longPressTimer = null;
                        let isLongPress = false;

                        cell.addEventListener('touchstart', (e) => {
                            isLongPress = false; // é‡ç½®é•¿æŒ‰çŠ¶æ€
                            longPressTimer = setTimeout(() => {
                                handleRightClick(x, y); // é•¿æŒ‰æ—¶æ ‡è®°
                                isLongPress = true;
                                longPressTimer = null;
                            }, 500); // 500ms é•¿æŒ‰
                        });

                        cell.addEventListener('touchmove', () => {
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        });

                        // è§¦æ‘¸ç»“æŸäº‹ä»¶ - å¤„ç†çŸ­æŒ‰ï¼ˆç‚¹å‡»ï¼‰
                        cell.addEventListener('touchend', (e) => {
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;

                                // åªæœ‰åœ¨ä¸æ˜¯é•¿æŒ‰çš„æƒ…å†µä¸‹æ‰å¤„ç†ç‚¹å‡»
                                if (!isLongPress) {
                                    setTimeout(() => {
                                        handleCellClick(x, y);
                                    }, 10); // å°å»¶è¿Ÿç¡®ä¿è§¦æ‘¸äº‹ä»¶å·²ç»å¤„ç†
                                }
                            }
                        });

                        // é˜²æ­¢è§¦æ‘¸æ—¶çš„é»˜è®¤è¡Œä¸ºï¼ˆå¦‚æ»šåŠ¨ï¼‰
                        cell.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                        }, { passive: false });

                        // PCç«¯äº‹ä»¶
                        cell.addEventListener('click', (e) => {
                            e.preventDefault();
                            handleCellClick(x, y);
                        });

                        // å³é”®ç‚¹å‡»äº‹ä»¶ï¼ˆPCç«¯æ ‡è®°ï¼‰
                        cell.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            handleRightClick(x, y);
                        });

                        boardElement.appendChild(cell);
                    }
                }
            }

            // æ ¹æ®éš¾åº¦å’Œå±å¹•å°ºå¯¸åŠ¨æ€è°ƒæ•´æ¸¸æˆæ¿å¤§å°
            function adjustBoardSize() {
                const boardElement = document.getElementById('board');
                const containerElement = document.querySelector('.game-container');
                const screenWidth = window.innerWidth;

                // è®¡ç®—åˆé€‚çš„å¤§å°
                let maxWidth, cellSize;

                if (screenWidth <= 360) {
                    // è¶…å°å±å¹•
                    cellSize = Math.floor((screenWidth - 40) / cols);
                    maxWidth = Math.min(cellSize * cols, 300);
                } else if (screenWidth <= 480) {
                    // å°å±æ‰‹æœº
                    cellSize = Math.floor((screenWidth - 50) / cols);
                    maxWidth = Math.min(cellSize * cols, 340);
                } else if (screenWidth <= 768) {
                    // å¹³æ¿ç«–å±
                    cellSize = Math.floor((screenWidth - 60) / cols);
                    maxWidth = Math.min(cellSize * cols, 360);
                } else if (screenWidth <= 1024) {
                    // å¹³æ¿æ¨ªå±
                    cellSize = Math.floor((screenWidth - 80) / cols);
                    maxWidth = Math.min(cellSize * cols, 450);
                } else {
                    // æ¡Œé¢ç«¯
                    cellSize = Math.floor((screenWidth - 100) / cols);
                    maxWidth = Math.min(cellSize * cols, 500);
                }

                // ç¡®ä¿æœ€å°å•å…ƒæ ¼å¤§å°
                const minCellSize = currentDifficulty === 'hard' ? 14 : 16;
                const adjustedMaxWidth = Math.max(minCellSize * cols, maxWidth);

                boardElement.style.maxWidth = `${adjustedMaxWidth}px`;

                // åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    if (cols >= 20) {
                        cell.style.fontSize = `${Math.max(10, minCellSize - 4)}px`;
                    } else if (cols >= 15) {
                        cell.style.fontSize = `${Math.max(11, minCellSize - 3)}px`;
                    } else {
                        cell.style.fontSize = `${Math.max(12, minCellSize - 2)}px`;
                    }
                });
            }
            
            // æ”¾ç½®åœ°é›·
            function placeMines(firstX, firstY) {
                let minesPlaced = 0;
                
                while (minesPlaced < mines) {
                    const x = Math.floor(Math.random() * cols);
                    const y = Math.floor(Math.random() * rows);
                    
                    // ç¡®ä¿ä¸åœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»çš„ä½ç½®åŠå…¶å‘¨å›´æ”¾ç½®åœ°é›·
                    const isFirstClickArea = Math.abs(x - firstX) <= 1 && Math.abs(y - firstY) <= 1;
                    
                    if (!board[y][x].isMine && !isFirstClickArea) {
                        board[y][x].isMine = true;
                        minesPlaced++;
                        
                        // æ›´æ–°å‘¨å›´æ ¼å­çš„é‚»è¿‘åœ°é›·æ•°
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const nx = x + dx;
                                const ny = y + dy;
                                
                                if (nx >= 0 && nx < cols && ny >= 0 && ny < rows && !board[ny][nx].isMine) {
                                    board[ny][nx].neighborCount++;
                                }
                            }
                        }
                    }
                }
            }
            
            // å¤„ç†æ ¼å­ç‚¹å‡»
            function handleCellClick(x, y) {
                if (gameOver || board[y][x].isRevealed || board[y][x].isFlagged) return;
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œæ”¾ç½®åœ°é›·
                if (!gameStarted) {
                    placeMines(x, y);
                    gameStarted = true;
                    startTimer();
                }
                
                revealCell(x, y);
                
                if (board[y][x].isMine) {
                    // æ¸¸æˆç»“æŸ
                    gameOver = true;
                    const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                    cell.classList.add('explosion'); // æ·»åŠ çˆ†ç‚¸åŠ¨ç”»
                    revealAllMines();
                    clearInterval(timerInterval);
                    
                    // ä½¿ç”¨è®°åˆ†ç®¡ç†æ¨¡å—è®°å½•æ¸¸æˆç»“æœ
                    scoreManager.recordGameResult('minesweeper', 'loss', seconds);
                    
                    setTimeout(() => {
                        alert('è¸©åˆ°åœ°é›·äº†ï¼æ¸¸æˆç»“æŸã€‚ç”¨æ—¶: ' + seconds + 'ç§’');
                    }, 100);
                } else {
                    // æ£€æŸ¥æ˜¯å¦èƒœåˆ© - æ­å¼€æ‰€æœ‰éé›·æ ¼å­
                    checkWinCondition();
                }
            }
            
            // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
            function checkWinCondition() {
                // ç»Ÿè®¡å·²æ­å¼€çš„æ ¼å­æ•°
                let revealedCount = 0;
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        if (board[y][x].isRevealed) {
                            revealedCount++;
                        }
                    }
                }

                // å¦‚æœå·²æ­å¼€çš„æ ¼å­æ•°ç­‰äºéé›·æ ¼å­æ•°ï¼Œåˆ™èƒœåˆ©
                if (revealedCount === rows * cols - mines) {
                    gameOver = true;
                    clearInterval(timerInterval);

                    // æ£€æŸ¥å¹¶æ›´æ–°æœ€ä½³æ—¶é—´è®°å½•ï¼ˆä½¿ç”¨éš¾åº¦åŒºåˆ†çš„keyï¼‰
                    const key = `minesweeper_${currentDifficulty}`;
                    if (seconds < bestTime) {
                        bestTime = seconds;
                        document.getElementById('best-time').textContent = bestTime;
                        scoreManager.updateHighScore(key, bestTime);
                    }

                    // ä½¿ç”¨è®°åˆ†ç®¡ç†æ¨¡å—è®°å½•æ¸¸æˆç»“æœ
                    scoreManager.recordGameResult('minesweeper', 'win', seconds);

                    // ä¸ºæ‰€æœ‰æ ¼å­æ·»åŠ è·èƒœåŠ¨ç”»
                    const cells = document.querySelectorAll('.cell');
                    cells.forEach(cell => {
                        cell.classList.add('win-glow');
                    });

                    setTimeout(() => {
                        alert('æ­å–œï¼ä½ æˆåŠŸæ¸…é™¤äº†æ‰€æœ‰åœ°é›·ï¼ç”¨æ—¶: ' + seconds + 'ç§’');
                    }, 100);
                }
            }
            
            // å¤„ç†å³é”®ç‚¹å‡»ï¼ˆæ ‡è®°ï¼‰- ç”¨äºPCå’Œç§»åŠ¨ç«¯é•¿æŒ‰
            function handleRightClick(x, y) {
                if (gameOver || board[y][x].isRevealed) return;
                
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                
                if (!board[y][x].isFlagged) {
                    // å¦‚æœè¿˜æœ‰å‰©ä½™çš„é›·å¯ä»¥æ ‡è®°
                    if (flags < mines) {
                        board[y][x].isFlagged = true;
                        cell.classList.add('flagged');
                        flags++;
                        
                        // æ£€æŸ¥æ˜¯å¦æ ‡è®°çš„æ˜¯çœŸæ­£çš„åœ°é›·
                        if (board[y][x].isMine) {
                            correctFlags++;
                        }
                    }
                } else {
                    board[y][x].isFlagged = false;
                    cell.classList.remove('flagged');
                    flags--;
                    
                    // å¦‚æœä¹‹å‰æ ‡è®°çš„æ˜¯çœŸæ­£çš„åœ°é›·ï¼Œå‡å°‘æ­£ç¡®æ ‡è®°æ•°
                    if (board[y][x].isMine) {
                        correctFlags--;
                    }
                }
                
                // æ›´æ–°æ ‡è®°è®¡æ•°
                updateFlagsCount();
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åœ°é›·éƒ½è¢«æ­£ç¡®æ ‡è®°
                if (correctFlags === mines) {
                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰éé›·æ ¼å­éƒ½å·²æ­å¼€
                    let allNonMinesRevealed = true;
                    for (let y = 0; y < rows; y++) {
                        for (let x = 0; x < cols; x++) {
                            if (!board[y][x].isMine && !board[y][x].isRevealed) {
                                allNonMinesRevealed = false;
                                break;
                            }
                        }
                        if (!allNonMinesRevealed) break;
                    }
                    
                    // å¦‚æœæ‰€æœ‰é›·éƒ½è¢«æ­£ç¡®æ ‡è®°ä¸”æ‰€æœ‰éé›·æ ¼å­å·²æ­å¼€ï¼Œåˆ™èƒœåˆ©
                    if (allNonMinesRevealed) {
                        gameOver = true;
                        clearInterval(timerInterval);
                        
                        // ä½¿ç”¨è®°åˆ†ç®¡ç†æ¨¡å—è®°å½•æ¸¸æˆç»“æœ
                        scoreManager.recordGameResult('minesweeper', 'win', seconds);
                        
                        // ä¸ºæ‰€æœ‰æ ¼å­æ·»åŠ è·èƒœåŠ¨ç”»
                        const cells = document.querySelectorAll('.cell');
                        cells.forEach(cell => {
                            cell.classList.add('win-glow');
                        });
                        
                        setTimeout(() => {
                            alert('æ­å–œï¼ä½ æˆåŠŸæ ‡è®°äº†æ‰€æœ‰åœ°é›·ï¼ç”¨æ—¶: ' + seconds + 'ç§’');
                        }, 100);
                    }
                }
            }
            
            // æ›´æ–°æ ‡è®°è®¡æ•°æ˜¾ç¤º
            function updateFlagsCount() {
                document.getElementById('flags-count').textContent = flags;
                // è®¡ç®—å‰©ä½™é›·æ•°ï¼ˆä»…å½“æ ‡è®°æ­£ç¡®æ—¶æ‰å‡å°‘ï¼‰
                const remainingMines = mines - correctFlags;
                document.getElementById('mines-count').textContent = remainingMines;
            }
            
            // æ­å¼€æ ¼å­
            function revealCell(x, y) {
                if (x < 0 || x >= cols || y < 0 || y >= rows) return;
                if (board[y][x].isRevealed || board[y][x].isFlagged) return;
                
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                board[y][x].isRevealed = true;
                cell.classList.add('revealed');
                revealed++;
                
                if (board[y][x].isMine) {
                    cell.classList.add('mine');
                    cell.textContent = 'ğŸ’£';
                } else if (board[y][x].neighborCount > 0) {
                    cell.textContent = board[y][x].neighborCount;
                    cell.classList.add(`cell-${board[y][x].neighborCount}`);
                } else {
                    // é€’å½’æ­å¼€å‘¨å›´æ ¼å­
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            revealCell(x + dx, y + dy);
                        }
                    }
                }
            }
            
            // æ­å¼€æ‰€æœ‰åœ°é›·
            function revealAllMines() {
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        if (board[y][x].isMine) {
                            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                            if (!cell.classList.contains('flagged')) {
                                cell.classList.add('revealed', 'mine', 'explosion');
                                cell.textContent = 'ğŸ’£';
                            }
                        }
                    }
                }
            }
            
            // å¼€å§‹è®¡æ—¶
            function startTimer() {
                timerInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('timer').textContent = seconds;
                }, 1000);
            }
            
            // è®°å½•æœ€ä½³æ—¶é—´
            let bestTime = Infinity; // åˆå§‹åŒ–ä¸ºæ— ç©·å¤§

            // åŠ è½½å½“å‰éš¾åº¦çš„æœ€ä½³æ—¶é—´
            function loadBestTime() {
                const key = `minesweeper_${currentDifficulty}`;
                scoreManager.getHighScore(key, Infinity).then(loadedBestTime => {
                    bestTime = loadedBestTime;
                    document.getElementById('best-time').textContent = bestTime === Infinity ? '-' : bestTime;
                });
            }

            // é‡ç½®æ¸¸æˆ
            document.getElementById('resetBtn').addEventListener('click', initGame);

            // éš¾åº¦é€‰æ‹©æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setDifficulty(btn.dataset.difficulty);
                });
            });

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ŒåŠ¨æ€è°ƒæ•´æ¸¸æˆæ¿å¤§å°
            window.addEventListener('resize', () => {
                if (!gameStarted || gameOver) {
                    adjustBoardSize();
                }
            });

            // ç›‘å¬è®¾å¤‡æ–¹å‘å˜åŒ–
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    adjustBoardSize();
                }, 100);
            });

            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
            // åŠ è½½æœ€ä½³æ—¶é—´
            loadBestTime();

            // é‡å†™è¿”å›ä¸»é¡µæŒ‰é’®çš„é€»è¾‘ï¼Œæ·»åŠ æäº¤åˆ†æ•°é€‰é¡¹
            const backHomeButton = document.querySelector('.back-home');
            if (backHomeButton) {
                backHomeButton.addEventListener('click', function(e) {
                    e.preventDefault();

                    // å¦‚æœæ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯¢é—®æ˜¯å¦ä¿å­˜
                    if (gameStarted && !gameOver) {
                        const shouldSave = confirm(`å½“å‰ç”¨æ—¶: ${seconds}ç§’\næ˜¯å¦å°†å½“å‰è¿›åº¦æ·»åŠ åˆ°æ’è¡Œæ¦œï¼Ÿ`);
                        if (shouldSave) {
                            // è·³è½¬åˆ°ä¸»é¡µå¹¶å¸¦ä¸Šæ—¶é—´ã€æ¸¸æˆç±»å‹å’ŒçŠ¶æ€å‚æ•°
                            window.location.href = `../index.html?score=${seconds}&game=minesweeper`;
                        } else {
                            // ç›´æ¥è¿”å›ä¸»é¡µ
                            window.location.href = `../index.html`;
                        }
                    } else if (gameOver) {
                        // æ¸¸æˆç»“æŸæ—¶ï¼Œè¯¢é—®æ˜¯å¦æäº¤æœ€ç»ˆæ—¶é—´
                        const shouldSave = confirm(`æ¸¸æˆç»“æŸï¼ç”¨æ—¶: ${seconds}ç§’\næ˜¯å¦å°†æ­¤æˆç»©æ·»åŠ åˆ°æ’è¡Œæ¦œï¼Ÿ`);
                        if (shouldSave) {
                            window.location.href = `../index.html?score=${seconds}&game=minesweeper`;
                        } else {
                            window.location.href = `../index.html`;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰è¿›è¡Œæ¸¸æˆï¼Œç›´æ¥è¿”å›ä¸»é¡µ
                        window.location.href = `../index.html`;
                    }
                });
            }
            
            // æ•™ç¨‹æ¨¡æ€æ¡†é€»è¾‘
            const tutorialModal = document.getElementById('tutorial-modal');
            const tutorialBtn = document.getElementById('tutorial-btn');
            const tutorialClose = document.querySelector('.tutorial-close');
            
            if (tutorialBtn) {
                tutorialBtn.addEventListener('click', () => {
                    tutorialModal.classList.add('active');
                });
            }
            
            if (tutorialClose) {
                tutorialClose.addEventListener('click', () => {
                    tutorialModal.classList.remove('active');
                });
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            tutorialModal.addEventListener('click', (e) => {
                if (e.target === tutorialModal) {
                    tutorialModal.classList.remove('active');
                }
            });
            
            // åˆå§‹åŒ–æ¸¸æˆç†Ÿæ‚‰åº¦ç³»ç»Ÿ
            if (window.gameFamiliaritySystem) {
                window.gameFamiliaritySystem.init('minesweeper', 'æ‰«é›·');
            }
        });
    </script>
    <script src="../js/gameFamiliarity.js"></script>
</body>
</html>